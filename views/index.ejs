<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kapan Beli - Catatan Stok Bahan Masak</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ““</text></svg>" type="image/x-icon">

    <style>
        /* --- VARIABEL & TEMA --- */
        :root {
            /* Warna: Oranye Segar & Biru Profesional */
            --primary-orange: #FF9F43;
            --primary-blue: #2E86DE;
            --accent-green: #1DD1A1;
            --accent-red: #FF6B6B;
            
            /* Light Mode (Notebook Paper) */
            --bg-body: #F7F9FC;
            --bg-card: #FFFFFF;
            --text-main: #2C3E50;
            --text-muted: #8395A7;
            --nav-bg: rgba(255, 255, 255, 0.85);
            --shadow-card: 0 8px 24px rgba(149, 157, 165, 0.08);
            --shadow-hover: 0 12px 32px rgba(149, 157, 165, 0.15);
            --shadow-search: 0 15px 35px rgba(0,0,0,0.1);
            --border-radius: 24px;
            
            /* Pattern Dot Grid */
            --dot-color: #E1E8ED;
        }

        /* Dark Mode */
        body.dark-mode-active {
            --bg-body: #1E272E;
            --bg-card: #2C3E50;
            --text-main: #DFE6E9;
            --text-muted: #808E9B;
            --nav-bg: rgba(30, 39, 46, 0.9);
            --shadow-card: 0 8px 24px rgba(0, 0, 0, 0.2);
            --shadow-hover: 0 12px 32px rgba(0, 0, 0, 0.4);
            --shadow-search: 0 15px 35px rgba(0,0,0,0.5);
            --dot-color: #34495E;
        }

        /* --- RESET & GLOBAL --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease, transform 0.3s ease;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-body);
            background-image: radial-gradient(var(--dot-color) 1.5px, transparent 1.5px);
            background-size: 24px 24px;
            color: var(--text-main);
            line-height: 1.7;
            overflow-x: hidden;
        }

        ::selection { background: var(--primary-orange); color: white; }
        a { text-decoration: none; color: inherit; cursor: pointer; }
        ul { list-style: none; }

        /* --- ANIMASI --- */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }

        .animate-entry {
            opacity: 0; /* Mulai tersembunyi */
            animation: fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        .delay-1 { animation-delay: 0.1s; }
        .delay-2 { animation-delay: 0.2s; }
        .delay-3 { animation-delay: 0.3s; }
        .delay-4 { animation-delay: 0.4s; }

        /* --- NAVBAR --- */
        .navbar {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: var(--nav-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.02);
            padding: 1rem 0;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 800;
            font-size: 1.4rem;
            letter-spacing: -0.5px;
            color: var(--text-main);
        }

        .nav-brand i { color: var(--primary-orange); font-size: 1.6rem; }

        .nav-menu {
            display: flex;
            gap: 2.5rem;
        }

        .nav-link {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-muted);
            position: relative;
            padding: 5px 0;
        }

        .nav-link:hover, .nav-link.active { color: var(--primary-blue); }

        .nav-link::after {
            content: ''; position: absolute; width: 0; height: 2px; bottom: 0; left: 0;
            background-color: var(--primary-orange); transition: width 0.3s ease; border-radius: 2px;
        }
        .nav-link:hover::after, .nav-link.active::after { width: 100%; }

        .nav-actions { display: flex; align-items: center; gap: 1.2rem; }

        .btn-text { font-weight: 600; color: var(--primary-blue); font-size: 0.9rem; }
        .btn-text:hover { color: var(--primary-orange); }

        .dark-mode-toggle {
            background: transparent; 
            border: none;
            color: var(--text-main); width: 38px; height: 38px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            font-size: 0.9rem; opacity: 0.8;
        }
        .dark-mode-toggle:hover {
            opacity: 1; background-color: rgba(255, 159, 67, 0.1); color: var(--primary-orange); transform: rotate(15deg);
        }

        /* --- HERO SECTION --- */
        .hero {
            max-width: 1200px;
            margin: 4rem auto;
            padding: 0 24px;
            display: flex;
            align-items: center;
            min-height: 75vh;
            position: relative;
            overflow: hidden;
            border-radius: var(--border-radius);
        }

        /* --- SEARCH BAR STYLE (REVAMPED) --- */
        .search-container {
            position: relative;
            max-width: 550px; /* Sedikit lebih lebar */
            margin-bottom: 2.5rem;
            width: 100%;
            z-index: 200; /* Di atas konten lain */
        }

        .search-container input {
            width: 100%;
            padding: 18px 25px 18px 55px;
            border: 2px solid transparent;
            border-radius: 50px;
            background: var(--bg-card);
            box-shadow: var(--shadow-card);
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
            color: var(--text-main);
            outline: none;
            transition: all 0.3s ease;
        }

        .search-container input:focus { 
            box-shadow: 0 0 0 4px rgba(255, 159, 67, 0.2), var(--shadow-card); 
            transform: translateY(-2px); 
            border-color: var(--primary-orange);
            background: var(--bg-card);
        }

        .search-container i { 
            position: absolute; 
            left: 22px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: var(--primary-orange); 
            font-size: 1.2rem; 
            pointer-events: none; /* Agar klik ikon fokus ke input */
        }

        /* Search Results Dropdown */
        .search-results {
            position: absolute;
            top: calc(100% + 12px); /* Jarak 12px dari input */
            left: 0;
            width: 100%;
            background: var(--bg-card);
            border-radius: 20px;
            box-shadow: var(--shadow-search);
            z-index: 1000;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .search-results.active {
            max-height: 450px; /* Tinggi maksimal saat terbuka */
            opacity: 1;
            overflow-y: auto; /* Scroll jika panjang */
            transform: translateY(0);
        }

        .search-result-item {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(0,0,0,0.03);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.2s ease;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background-color: rgba(255, 159, 67, 0.05);
            padding-left: 25px; /* Efek geser sedikit */
        }

        /* Search Item Content */
        .search-result-icon {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            background: rgba(46, 134, 222, 0.1);
            color: var(--primary-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
            transition: background 0.2s, color 0.2s;
        }

        .search-result-item:hover .search-result-icon {
            background: var(--primary-orange);
            color: white;
        }

        .search-result-content {
            flex: 1;
            min-width: 0; /* Mencegah teks overflow */
        }

        .search-result-title {
            font-weight: 600;
            color: var(--text-main);
            font-size: 1rem;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-result-type {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        /* Empty State for Search */
        .search-no-results {
            padding: 30px 20px;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .hero-bg-image {
            position: absolute; top: 0; right: 0; width: 65%; height: 100%;
            background-image: url('https://z-cdn-media.chatglm.cn/files/3aaa6c94-c363-47e0-886e-817084f4b407.jpeg?auth_key=1870694353-37fd08f5dca94279b617d21318047ad0-0-84c2bb20f2aedb79ed770e63f95cd4fe');
            background-size: cover; background-position: center; z-index: 0;
            -webkit-mask-image: linear-gradient(to left, rgba(0,0,0,1) 50%, rgba(0,0,0,0) 100%);
            mask-image: linear-gradient(to left, rgba(0,0,0,1) 50%, rgba(0,0,0,0) 100%);
            transform: rotate(-1deg); border-radius: 30px 0 0 30px;
        }

        .hero-text { flex: 1; z-index: 2; position: relative; max-width: 550px; }

        .greeting-badge {
            display: inline-flex; align-items: center; gap: 8px;
            background: rgba(46, 134, 222, 0.1); color: var(--primary-blue);
            padding: 8px 20px; border-radius: 100px; font-size: 0.9rem; font-weight: 600;
            margin-bottom: 1.5rem; border: 1px solid rgba(46, 134, 222, 0.1);
            backdrop-filter: blur(4px); background-color: rgba(255, 255, 255, 0.85);
        }
        body.dark-mode-active .greeting-badge { background-color: rgba(30, 39, 46, 0.85); }

        .hero h1 {
            font-size: 3.8rem; line-height: 1.1; margin-bottom: 1.5rem;
            color: var(--text-main); letter-spacing: -1.5px; font-weight: 800;
        }

        .hero h1 span { color: var(--primary-orange); position: relative; display: inline-block; }
        
        .hero h1 span::after {
            content: ''; position: absolute; left: 0; bottom: 8px; width: 100%; height: 14px;
            background-color: rgba(255, 159, 67, 0.2); z-index: -1; border-radius: 4px;
        }

        .hero p { font-size: 1.15rem; color: var(--text-muted); margin-bottom: 2rem; max-width: 480px; line-height: 1.8; }

        .hero-buttons { display: flex; gap: 1rem; flex-wrap: wrap; }
        .cta-button {
            background-color: var(--primary-orange); color: white; padding: 16px 36px;
            border-radius: 100px; font-weight: 600; font-size: 1rem;
            box-shadow: 0 10px 25px rgba(255, 159, 67, 0.4); transition: all 0.3s;
            display: inline-flex; align-items: center; gap: 10px; border: none; cursor: pointer;
        }
        .cta-button:hover { transform: translateY(-4px); box-shadow: 0 15px 30px rgba(255, 159, 67, 0.5); background-color: #f08c38; }

        .secondary-button {
            background-color: var(--bg-card); border: 2px solid rgba(0,0,0,0.05);
            color: var(--text-main); padding: 14px 32px; border-radius: 100px; font-weight: 600;
            box-shadow: var(--shadow-card);
        }
        .secondary-button:hover { border-color: var(--primary-blue); color: var(--primary-blue); }

        /* --- SECTIONS UMUM --- */
        .section { padding: 5rem 24px; position: relative; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3rem; }
        
        .section-title {
            font-size: 2.2rem; color: var(--text-main); font-weight: 700;
            position: relative; display: inline-block;
        }
        .section-title::after { content: ''; display: block; width: 60px; height: 4px; background: var(--primary-orange); margin-top: 8px; border-radius: 2px; }

        .view-all-link { font-weight: 600; color: var(--primary-blue); display: flex; align-items: center; gap: 8px; transition: 0.3s; }
        .view-all-link:hover { color: var(--primary-orange); gap: 12px; }

        /* --- STATS SECTION (RINGKASAN DAPUR) --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; }
        
        .stat-card {
            background: var(--bg-card); padding: 2.5rem 2rem; border-radius: var(--border-radius);
            box-shadow: var(--shadow-card); text-align: center; border: 1px solid rgba(0,0,0,0.02);
            transition: all 0.4s ease; position: relative; overflow: hidden;
        }

        .stat-card:hover { transform: translateY(-10px); box-shadow: var(--shadow-hover); border-color: rgba(255, 159, 67, 0.3); }

        /* Hiasan background halus pada kartu stat */
        .stat-card::before {
            content: ''; position: absolute; top: -50px; right: -50px; width: 150px; height: 150px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            border-radius: 50%;
        }

        .stat-icon {
            font-size: 2.2rem; margin-bottom: 1.2rem; color: var(--primary-blue);
            background: rgba(46, 134, 222, 0.1); width: 75px; height: 75px; line-height: 75px;
            border-radius: 50%; margin-left: auto; margin-right: auto; transition: 0.3s;
        }

        .stat-card:hover .stat-icon { transform: scale(1.1) rotate(5deg); background: var(--primary-blue); color: white; }

        /* Variasi Warna Stat */
        .stat-card.danger .stat-icon { color: var(--accent-red); background: rgba(255, 107, 107, 0.1); }
        .stat-card.danger:hover .stat-icon { background: var(--accent-red); }
        
        .stat-card.warning .stat-icon { color: var(--primary-orange); background: rgba(255, 159, 67, 0.1); }
        .stat-card.warning:hover .stat-icon { background: var(--primary-orange); }

        .stat-value { font-size: 3rem; font-weight: 800; color: var(--text-main); margin-bottom: 0.2rem; line-height: 1; }
        .stat-label { color: var(--text-muted); font-weight: 600; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }

        /* --- PRODUCTS GRID (BAHAN SAYA) --- */
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 30px; }

        .product-card {
            background: var(--bg-card); border-radius: var(--border-radius); overflow: hidden;
            box-shadow: var(--shadow-card); display: flex; flex-direction: column;
            border: 1px solid rgba(0,0,0,0.03); transition: all 0.3s ease; position: relative;
        }

        .product-card:hover { transform: translateY(-8px); box-shadow: var(--shadow-hover); }

        .card-top {
            height: 150px; background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%);
            display: flex; align-items: center; justify-content: center; position: relative;
            overflow: hidden;
        }

        body.dark-mode-active .card-top { background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%); }

        .card-icon { font-size: 4.5rem; color: var(--primary-orange); z-index: 2; transition: 0.3s; }
        .product-card:hover .card-icon { transform: scale(1.1) rotate(-5deg); }

        .category-tag {
            position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.9);
            padding: 6px 14px; border-radius: 20px; font-size: 0.75rem; font-weight: 700;
            color: var(--primary-blue); box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 3; backdrop-filter: blur(4px);
        }

        .card-body { padding: 24px; flex: 1; display: flex; flex-direction: column; gap: 14px; }
        
        .prod-name { font-size: 1.25rem; font-weight: 700; margin: 0; cursor: pointer; transition: color 0.2s; }
        .prod-name:hover { color: var(--primary-orange); }

        .info-row {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.9rem; padding-bottom: 10px; border-bottom: 1px dashed rgba(0,0,0,0.08);
        }
        .info-row:last-child { border-bottom: none; padding-bottom: 0; }

        .label { color: var(--text-muted); display: flex; align-items: center; gap: 8px; font-weight: 500; }
        .value { font-weight: 700; color: var(--text-main); font-size: 1rem; }

        /* --- ACTIVITY LIST (AKTIVITAS TERKINI) --- */
        .activity-container {
            background: var(--bg-card); border-radius: var(--border-radius);
            padding: 2.5rem; box-shadow: var(--shadow-card);
        }

        .activity-item {
            display: flex; align-items: center; padding: 1.2rem 0;
            border-bottom: 1px solid rgba(0,0,0,0.05); transition: background 0.2s;
        }
        .activity-item:last-child { border-bottom: none; }
        .activity-item:hover { background-color: rgba(0,0,0,0.02); padding-left: 10px; padding-right: 10px; border-radius: 12px; }

        .activity-icon {
            width: 50px; height: 50px; border-radius: 14px; display: flex; align-items: center; justify-content: center;
            margin-right: 1.5rem; font-size: 1.3rem; flex-shrink: 0;
        }

        /* Warna icon berdasarkan tipe */
        .act-add { background: rgba(29, 209, 161, 0.15); color: var(--accent-green); }
        .act-warning { background: rgba(255, 107, 107, 0.15); color: var(--accent-red); }
        .act-note { background: rgba(253, 203, 110, 0.2); color: #f39c12; }
        .act-cart { background: rgba(46, 134, 222, 0.15); color: var(--primary-blue); }

        .activity-content { flex: 1; }
        .activity-title { font-weight: 600; font-size: 1rem; color: var(--text-main); display: block; margin-bottom: 4px; }
        .activity-desc { font-size: 0.85rem; color: var(--text-muted); display: block; }
        .activity-time { font-size: 0.75rem; color: var(--text-muted); margin-top: 6px; font-weight: 500; opacity: 0.8; text-transform: uppercase; letter-spacing: 0.5px;}

        /* --- FOOTER --- */
        .footer {
            text-align: center; padding: 4rem 0; margin-top: 4rem; color: var(--text-muted);
            border-top: 1px solid rgba(0,0,0,0.05); background-color: var(--bg-card);
        }

        /* --- RESPONSIVE --- */
        @media (max-width: 968px) {
            .hero { flex-direction: column; text-align: center; gap: 2rem; margin-top: 2rem; padding-bottom: 2rem; }
            .hero-bg-image {
                position: relative; width: 100%; height: 300px; top: 0; right: 0;
                border-radius: 0 0 30px 30px; mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 70%, rgba(0,0,0,0) 100%);
                -webkit-mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 70%, rgba(0,0,0,0) 100%);
                order: -1; margin-bottom: 2rem;
            }
            .nav-menu { display: none; }
            .section-title { font-size: 1.8rem; }
        }

        /* Mobile Extra Small */
        @media (max-width: 576px) {
            .hero h1 { font-size: 2.2rem; }
            .hero p { font-size: 1rem; }
            
            .section { padding: 3rem 16px; }
            
            .stats-grid { grid-template-columns: 1fr; }
            
            .products-grid { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        }

        /* Tablet */
        @media (min-width: 577px) and (max-width: 768px) {
            .products-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>

    <%- include('./partials/navbar') %>

    <!-- HERO SECTION -->
    <section class="hero">
        <div class="hero-bg-image"></div>
        <div class="hero-text animate-entry delay-1">
            <span class="greeting-badge" id="greetingBadge">
                <i class="fas fa-sun"></i> <span id="greetingText">Selamat Pagi</span>
            </span>
            <h1>Catat Stok, <br><span>Matang Tanpa Ribet.</span></h1>
            <p>
                Asisten cerdas untuk mengelola stok dapur Anda. 
                Dapatkan notifikasi bahan habis, rekap belanja otomatis, dan temukan resep dengan mudah.
            </p>
            
            <div class="search-container animate-entry delay-2">
                <i class="fas fa-search"></i>
                <input type="text" id="heroSearch" placeholder="Cari bahan, resep, atau catatan..." autocomplete="off">
                <div class="search-results" id="searchResults">
                    <!-- Results will be injected here -->
                </div>
            </div>

            <div class="hero-buttons animate-entry delay-3">
                <a href="/auth" class="cta-button" id="mainActionBtn">
                    Mulai Catat <i class="fas fa-arrow-right"></i>
                </a>
                <a href="#features" class="secondary-button">Pelajari</a>
            </div>
        </div>
    </section>

    <!-- STATS SECTION -->
    <section class="section" id="features">
        <div class="container">
            <h2 class="section-title animate-entry delay-1" style="display:block; text-align:center;">Ringkasan Dapur</h2>
            <div class="stats-grid" id="statsGrid">
                <!-- Statistik akan dimuat via JS -->
                <div class="stat-card animate-entry delay-1">
                    <div class="stat-icon"><i class="fas fa-box-open"></i></div>
                    <div class="stat-value">0</div>
                    <div class="stat-label">Total Bahan</div>
                </div>
                <div class="stat-card danger animate-entry delay-2">
                    <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="stat-value">0</div>
                    <div class="stat-label">Stok Menipis</div>
                </div>
                <div class="stat-card warning animate-entry delay-3">
                    <div class="stat-icon"><i class="fas fa-clipboard-list"></i></div>
                    <div class="stat-value">0</div>
                    <div class="stat-label">Daftar Belanja</div>
                </div>
                <div class="stat-card expired animate-entry delay-4">
                    <div class="stat-icon"><i class="fas fa-skull-crossbones"></i></div>
                    <div class="stat-value">0</div>
                    <div class="stat-label">Kadaluarsa</div>
                </div>
                <div class="stat-card expiring animate-entry delay-4">
                    <div class="stat-icon"><i class="fas fa-hourglass-half"></i></div>
                    <div class="stat-value">0</div>
                    <div class="stat-label">Hampir Kadaluarsa</div>
                </div>
                <div class="stat-card notes animate-entry delay-4">
                    <div class="stat-icon"><i class="fas fa-sticky-note"></i></div>
                    <div class="stat-value">0</div>
                    <div class="stat-label">Catatan</div>
                </div>
            </div>
        </div>
    </section>

    <!-- EMPTY STOCK WARNING SECTION (Conditional) -->
    <section class="section" id="emptyStockSection" style="display: none; background-color: rgba(255, 107, 107, 0.05);">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title" style="color: var(--accent-red);"><i class="fas fa-bell"></i> Segera Beli!</h2>
                <a href="/suggestions" class="view-all-link" style="color: var(--accent-red);">Lihat Daftar Belanja <i class="fas fa-arrow-right"></i></a>
            </div>
            <div class="products-grid" id="emptyStockGrid"></div>
        </div>
    </section>

    <!-- PRODUCTS SECTION -->
    <section class="section" id="productsSection" style="display: none;">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title">Bahan Saya Terbaru</h2>
                <a href="/products" class="view-all-link">Lihat Semua <i class="fas fa-arrow-right"></i></a>
            </div>
            <div class="products-grid" id="recentProductsGrid">
                <!-- Products will be loaded dynamically -->
            </div>
        </div>
    </section>

    <!-- ACTIVITY LIST -->
    <section class="section" style="background-color: rgba(0,0,0,0.02);">
        <div class="container">
            <h2 class="section-title" style="display:block; text-align:center; margin-bottom: 3rem;">Aktivitas Terkini</h2>
            <div class="activity-container animate-entry delay-2" style="max-width: 900px; margin: 0 auto;">
                <ul class="activity-list" style="padding: 0;" id="activityList">
                    <!-- Activities will be loaded dynamically -->
                </ul>
            </div>
        </div>
    </section>

    <%- include('./partials/footer') %>

    <script>
        // --- LOGIC 1: WAKTU & SALAM ---
        function updateGreeting() {
            const hour = new Date().getHours();
            const greetingText = document.getElementById('greetingText');
            const greetingIcon = document.querySelector('.greeting-badge i');
            
            if (hour >= 5 && hour < 11) {
                greetingText.textContent = "Selamat Pagi";
                greetingIcon.className = "fas fa-sun"; 
            } else if (hour >= 11 && hour < 15) {
                greetingText.textContent = "Selamat Siang";
                greetingIcon.className = "fas fa-cloud-sun"; 
            } else if (hour >= 15 && hour < 18) {
                greetingText.textContent = "Selamat Sore";
                greetingIcon.className = "fas fa-cloud-sun-rain"; 
            } else {
                greetingText.textContent = "Selamat Malam";
                greetingIcon.className = "fas fa-moon"; 
            }
        }

        // --- LOGIC 2: DARK MODE ---
        const toggleBtn = document.querySelector('.dark-mode-toggle');
        const themeIcon = document.getElementById('themeIcon');
        const body = document.body;

        if (localStorage.getItem('theme') === 'dark') {
            enableDarkMode();
        }

        toggleBtn.addEventListener('click', () => {
            body.classList.contains('dark-mode-active') ? disableDarkMode() : enableDarkMode();
        });

        function enableDarkMode() {
            body.classList.add('dark-mode-active');
            localStorage.setItem('theme', 'dark');
            themeIcon.className = "fas fa-sun";
            themeIcon.style.color = "#F1C40F"; 
        }

        function disableDarkMode() {
            body.classList.remove('dark-mode-active');
            localStorage.setItem('theme', 'light');
            themeIcon.className = "fas fa-moon";
            themeIcon.style.color = ""; 
        }

        // --- LOGIC 3: SEARCH BAR (IMPROVED UI) ---
        const searchInput = document.getElementById('heroSearch');
        const searchResults = document.getElementById('searchResults');
        let searchTimeout = null; // Debounce timer

        searchInput.addEventListener('input', function (e) {
            const query = e.target.value.trim();
            
            // Clear previous timeout
            if (searchTimeout) clearTimeout(searchTimeout);

            if (query === '') {
                searchResults.classList.remove('active');
                return;
            }

            // Debounce request (tunggu 300ms setelah user berhenti mengetik)
            searchTimeout = setTimeout(async () => {
                try {
                    // Show loading state (optional, bisa ditambahkan spinner)
                    searchResults.innerHTML = '<div class="search-no-results"><i class="fas fa-spinner fa-spin"></i> Mencari...</div>';
                    searchResults.classList.add('active');

                    // Search across products, notes
                    const [productsRes, notesRes] = await Promise.all([
                        fetch('/api/products', { credentials: 'same-origin' }),
                        fetch('/api/notes', { credentials: 'same-origin' })
                    ]);

                    const [productsData, notesData] = await Promise.all([
                        productsRes.json(),
                        notesRes.json()
                    ]);

                    const allResults = [];

                    // Search in products
                    if (productsData.success && productsData.products) {
                        productsData.products.forEach(product => {
                            if (product.name.toLowerCase().includes(query.toLowerCase())) {
                                allResults.push({
                                    type: 'product',
                                    title: product.name,
                                    description: 'Bahan Dapur',
                                    id: product.id,
                                    link: `/products/detail/${product.id}`,
                                    icon: 'fa-box-open'
                                });
                            }
                        });
                    }

                    // Search in notes
                    if (notesData.success && notesData.notes) {
                        notesData.notes.forEach(note => {
                            if (note.title.toLowerCase().includes(query.toLowerCase())) {
                                allResults.push({
                                    type: 'note',
                                    title: note.title,
                                    description: 'Catatan Pribadi',
                                    id: note.id,
                                    link: `/notes`,
                                    icon: 'fa-sticky-note'
                                });
                            }
                        });
                    }

                    // Display results
                    if (allResults.length > 0) {
                        searchResults.innerHTML = allResults.slice(0, 5).map(result => `
                            <div class="search-result-item" onclick="window.location.href='${result.link}'">
                                <div class="search-result-icon">
                                    <i class="fas ${result.icon}"></i>
                                </div>
                                <div class="search-result-content">
                                    <div class="search-result-title">${result.title}</div>
                                    <div class="search-result-type">${result.description}</div>
                                </div>
                                <i class="fas fa-chevron-right" style="color: var(--text-muted); font-size: 0.8rem;"></i>
                            </div>
                        `).join('');
                    } else {
                        searchResults.innerHTML = `
                            <div class="search-no-results">
                                <i class="fas fa-search" style="font-size: 1.5rem; margin-bottom: 10px; opacity: 0.5;"></i>
                                <div>Tidak ada hasil untuk "${query}"</div>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    searchResults.innerHTML = `
                        <div class="search-no-results" style="color: var(--accent-red);">
                            Terjadi kesalahan saat mencari
                        </div>
                    `;
                }
            }, 300); // 300ms debounce
        });

        // Handle Enter key (optional: go to full search page or trigger first result)
        searchInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                const query = this.value;
                if(query.trim() !== "") {
                    // Simulasi navigasi ke halaman pencarian penuh
                    window.location.href = `/products?search=${encodeURIComponent(query)}`;
                }
            }
        });

        // Hide search results when clicking outside
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.classList.remove('active');
            }
        });

        // --- LOGIC 4: AUTH CHECK ---
        const authLink = document.getElementById('authLink');
        const logoutLink = document.getElementById('logoutLink');
        const welcomeText = document.getElementById('welcomeText');
        const mainActionBtn = document.getElementById('mainActionBtn');

        async function checkAuthStatus() {
            try {
                const response = await fetch('/auth/status', { method: 'GET', credentials: 'same-origin' });
                if (response.ok) {
                    const data = await response.json();
                    if (data.authenticated) {
                        authLink.style.display = 'none';
                        logoutLink.style.display = 'inline-block';
                        welcomeText.style.display = 'inline-block';
                        welcomeText.textContent = `Halo, ${data.user.name}!`;
                        mainActionBtn.innerHTML = 'Buka Catatan <i class="fas fa-book"></i>';
                        mainActionBtn.href = '/products';
                        return true; // Authenticated
                    }
                }
                // Default logged out state
                authLink.style.display = 'inline-block';
                logoutLink.style.display = 'none';
                welcomeText.style.display = 'none';
                mainActionBtn.innerHTML = 'Mulai Catat <i class="fas fa-arrow-right"></i>';
                mainActionBtn.href = '/auth';
                return false;
            } catch (error) {
                console.error('Auth check failed', error);
                return false;
            }
        }

        logoutLink.addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                const response = await fetch('/auth/logout', { method: 'POST', credentials: 'same-origin' });
                const data = await response.json();
                if (response.ok) {
                    window.location.href = data.redirect || '/';
                }
            } catch (error) { console.error('Logout error', error); }
        });

        // --- LOGIC 5: MAIN DASHBOARD DATA (UPDATED) ---
        
        // Helper: Format Tanggal Indonesia
        function formatDateID(dateString) {
            if(!dateString) return '-';
            const options = { day: 'numeric', month: 'short', year: 'numeric' };
            return new Date(dateString).toLocaleDateString('id-ID', options);
        }

        // Helper: Cek Status Kedaluwarsa
        function getExpiryStatus(dateString) {
            if(!dateString) return { text: '-', class: '' };
            const now = new Date();
            const exp = new Date(dateString);
            const diffTime = exp - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            
            if (diffDays < 0) return { text: 'Kadaluarsa', class: 'text-danger', color: 'var(--accent-red)' };
            if (diffDays <= 7) return { text: `${diffDays} Hari Lagi`, class: 'text-warning', color: '#f39c12' };
            return { text: formatDateID(dateString), class: 'text-success', color: 'var(--accent-green)' };
        }

        // Helper: Icon berdasarkan nama bahan
        function getIconForProduct(name) {
            const n = name.toLowerCase();
            if(n.includes('ayam')) return 'fa-drumstick-bite';
            if(n.includes('susu')) return 'fa-glass-whiskey';
            if(n.includes('telur')) return 'fa-egg';
            if(n.includes('bawang')) return 'fa-seedling';
            if(n.includes('beras') || n.includes('gandum')) return 'fa-wheat';
            if(n.includes('cabai')) return 'fa-pepper-hot';
            if(n.includes('minyak')) return 'fa-bottle-droplet';
            return 'fa-box-open';
        }

        // Helper: Format "Waktu Lalu"
        function formatTimeAgo(dateString) {
            if (!dateString) return 'Baru saja';
            const date = new Date(dateString);
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " tahun lalu";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " bulan lalu";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " hari lalu";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " jam lalu";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " menit lalu";
            return "Baru saja";
        }

        // Fungsi Utama Load Data
        async function loadDashboardData() {
            console.log('Loading dashboard data...');

            // 1. Fetch Stats (Ringkasan Dapur)
            try {
                const statsRes = await fetch('/api/products/stats', { credentials: 'same-origin' });
                console.log('Stats API response status:', statsRes.status); // Debug log
                if(statsRes.ok) {
                    const stats = await statsRes.json();
                    console.log('Stats received:', stats); // Debug log
                    // Update UI Stats dengan animasi angka sederhana
                    document.querySelector('#statsGrid .stat-card:nth-child(1) .stat-value').textContent = stats.total || 0;
                    document.querySelector('#statsGrid .stat-card:nth-child(2) .stat-value').textContent = stats.lowStock || 0;
                    document.querySelector('#statsGrid .stat-card:nth-child(3) .stat-value').textContent = stats.shoppingList || 0;
                    
                    // Update additional stats if they exist
                    if(document.querySelector('.stat-card.expired')) {
                        document.querySelector('.stat-card.expired .stat-value').textContent = stats.outOfStock || 0;
                    }
                } else {
                    console.error('Stats API returned error:', statsRes.status);
                    // Set default values if API fails
                    document.querySelector('#statsGrid .stat-card:nth-child(1) .stat-value').textContent = '0';
                    document.querySelector('#statsGrid .stat-card:nth-child(2) .stat-value').textContent = '0';
                    document.querySelector('#statsGrid .stat-card:nth-child(3) .stat-value').textContent = '0';
                }
            } catch (e) { 
                console.error('Stats API error:', e); 
                // Set default values if API fails
                document.querySelector('#statsGrid .stat-card:nth-child(1) .stat-value').textContent = '0';
                document.querySelector('#statsGrid .stat-card:nth-child(2) .stat-value').textContent = '0';
                document.querySelector('#statsGrid .stat-card:nth-child(3) .stat-value').textContent = '0';
            }

            // 2. Fetch Products (Bahan Saya & Stok Rendah)
            try {
                const prodRes = await fetch('/api/products', { credentials: 'same-origin' });
                console.log('Products API response status:', prodRes.status); // Debug log
                if(prodRes.ok) {
                    const data = await prodRes.json();
                    console.log('Products received:', data); // Debug log
                    if(data.success && data.products) {
                        renderProducts(data.products);
                        renderLowStockProducts(data.products); // Logic Deteksi Stok Rendah
                        
                        // Update kitchen summary with additional data
                        updateKitchenSummary(data.products);
                    } else {
                        console.error('Products API returned error:', data);
                    }
                } else {
                    console.error('Products API returned error:', prodRes.status);
                }
            } catch (e) { 
                console.error('Products API error', e); 
            }

            // 3. Fetch Notes
            try {
                const notesRes = await fetch('/api/notes', { credentials: 'same-origin' });
                console.log('Notes API response status:', notesRes.status); // Debug log
                if(notesRes.ok) {
                    const notesData = await notesRes.json();
                    console.log('Notes received:', notesData); // Debug log
                    if(notesData.success && notesData.notes) {
                        // Update kitchen summary with notes count
                        updateNotesSummary(notesData.notes);
                    } else {
                        console.error('Notes API returned error:', notesData);
                    }
                } else {
                    console.error('Notes API returned error:', notesRes.status);
                }
            } catch (e) { 
                console.error('Notes API error', e); 
            }

            // 4. Fetch & Render Activities
            await loadActivities();
        }

        // Function to force refresh dashboard data
        function refreshDashboardData() {
            console.log('Refreshing dashboard data...');
            loadDashboardData();
        }

        // Listen for events from other pages to refresh data
        window.addEventListener('productAdded', () => {
            setTimeout(refreshDashboardData, 1000); // Delay to allow server to process
        });

        window.addEventListener('productUpdated', () => {
            setTimeout(refreshDashboardData, 1000);
        });

        window.addEventListener('productDeleted', () => {
            setTimeout(refreshDashboardData, 1000);
        });

        window.addEventListener('noteAdded', () => {
            setTimeout(refreshDashboardData, 1000);
        });

        window.addEventListener('noteUpdated', () => {
            setTimeout(refreshDashboardData, 1000);
        });

        window.addEventListener('noteDeleted', () => {
            setTimeout(refreshDashboardData, 1000);
        });

        // Update kitchen summary with additional data
        function updateKitchenSummary(products) {
            // Calculate additional stats for kitchen summary
            const expiredProducts = products.filter(p => {
                if (!p.expiry_date) return false;
                const expiryDate = new Date(p.expiry_date);
                const today = new Date();
                return expiryDate < today;
            });
            
            const expiringSoon = products.filter(p => {
                if (!p.expiry_date) return false;
                const expiryDate = new Date(p.expiry_date);
                const today = new Date();
                const diffTime = expiryDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays > 0 && diffDays <= 7;
            });
            
            const lowStockProducts = products.filter(p => {
                const stock = parseFloat(p.stock_quantity) || 0;
                const minLevel = parseFloat(p.min_stock_level) || 5;
                return stock <= minLevel && stock > 0;
            });
            
            const outOfStockProducts = products.filter(p => {
                const stock = parseFloat(p.stock_quantity) || 0;
                return stock <= 0;
            });
            
            // Update existing values (the elements are already in HTML)
            if(document.querySelector('.stat-card.expired .stat-value')) {
                document.querySelector('.stat-card.expired .stat-value').textContent = expiredProducts.length;
            }
            if(document.querySelector('.stat-card.expiring .stat-value')) {
                document.querySelector('.stat-card.expiring .stat-value').textContent = expiringSoon.length;
            }
            if(document.querySelector('.stat-card.danger .stat-value')) {
                document.querySelector('.stat-card.danger .stat-value').textContent = lowStockProducts.length;
            }
            if(document.querySelector('.stat-card.warning .stat-value')) {
                document.querySelector('.stat-card.warning .stat-value').textContent = (lowStockProducts.length + outOfStockProducts.length);
            }
            if(document.querySelector('.stat-card:nth-child(1) .stat-value')) {
                document.querySelector('.stat-card:nth-child(1) .stat-value').textContent = products.length;
            }
        }

        // Update notes summary
        function updateNotesSummary(notes) {
            // Update existing value (the element is already in HTML)
            if(document.querySelector('.stat-card.notes .stat-value')) {
                document.querySelector('.stat-card.notes .stat-value').textContent = notes.length;
            }
        }

        // RENDER: Bahan Saya Terbaru
        function renderProducts(products) {
            const container = document.getElementById('recentProductsGrid');
            const section = document.getElementById('productsSection');
            
            if(products.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            container.innerHTML = '';
            
            // Ambil 6 terakhir
            products.slice(0, 6).forEach((prod, index) => {
                const expiryInfo = getExpiryStatus(prod.expiry_date);
                const isLow = parseFloat(prod.stock_quantity) <= parseFloat(prod.min_stock_level || 0);
                
                // Animasi delay bertahap
                const delayClass = index < 4 ? `delay-${index+1}` : 'delay-4';

                const card = `
                    <div class="product-card animate-entry ${delayClass}">
                        <div class="card-top">
                            <span class="category-tag">${prod.category_id || 'Umum'}</span>
                            ${prod.image_url 
                                ? `<img src="${prod.image_url}" style="width:100%; height:100%; object-fit:cover; position:absolute;">` 
                                : `<i class="fas ${getIconForProduct(prod.name)} card-icon"></i>`
                            }
                        </div>
                        <div class="card-body">
                            <h3 class="prod-name" onclick="window.location='/products/detail/${prod.id}'">${prod.name}</h3>
                            
                            <!-- MENAMPILKAN STOK & EXPIRY SESUAI REQUEST -->
                            <div class="info-row">
                                <span class="label"><i class="fas fa-boxes"></i> Stok</span>
                                <span class="value" style="color: ${isLow ? 'var(--accent-red)' : 'var(--text-main)'}">
                                    ${prod.stock_quantity} ${prod.unit || ''}
                                    ${isLow ? '<i class="fas fa-exclamation-circle" style="margin-left:5px; font-size:0.8rem;"></i>' : ''}
                                </span>
                            </div>
                            
                            <div class="info-row" style="border:none;">
                                <span class="label"><i class="fas fa-calendar-check"></i> Kedaluwarsa</span>
                                <span class="value" style="color: ${expiryInfo.color}">${expiryInfo.text}</span>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });
        }

        // RENDER: Stok Menipis (Otomatis muncul jika ada)
        function renderLowStockProducts(products) {
            const container = document.getElementById('emptyStockGrid');
            const section = document.getElementById('emptyStockSection');
            
            // Filter stok <= 0 (habis) atau stok <= min_stock (menipis)
            const lowStock = products.filter(p => parseFloat(p.stock_quantity) <= parseFloat(p.min_stock_level || 0));

            if(lowStock.length > 0) {
                section.style.display = 'block';
                container.innerHTML = '';
                
                lowStock.forEach((prod, index) => {
                    const delayClass = index < 3 ? `delay-${index+1}` : 'delay-3';
                    const card = `
                        <div class="product-card animate-entry ${delayClass}" style="border: 1px solid rgba(255, 107, 107, 0.3);">
                            <div class="card-top" style="background: rgba(255, 107, 107, 0.1);">
                                <span class="category-tag" style="background:var(--accent-red); color:white;">Darurat</span>
                                <i class="fas ${getIconForProduct(prod.name)} card-icon" style="color: var(--accent-red);"></i>
                            </div>
                            <div class="card-body">
                                <h3 class="prod-name">${prod.name}</h3>
                                <div class="info-row">
                                    <span class="label">Sisa Stok</span>
                                    <span class="value" style="color: var(--accent-red); font-weight:800;">${prod.stock_quantity} ${prod.unit}</span>
                                </div>
                                <div class="info-row" style="border:none;">
                                    <a href="/suggestions" class="cta-button" style="width:100%; justify-content:center; padding:10px; font-size:0.9rem; margin-top:10px;">
                                        <i class="fas fa-cart-plus"></i> Beli Sekarang
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += card;
                });
            } else {
                section.style.display = 'none';
            }
        }

        // LOGIC BARU: Aktivitas Terkini Cerdas
        async function loadActivities() {
            const list = document.getElementById('activityList');
            list.innerHTML = '<div style="text-align:center; padding:20px;"><i class="fas fa-spinner fa-spin"></i> Memuat aktivitas...</div>';

            try {
                // Fetch combined activities from the API endpoint
                let activities = [];
                
                // Try to get activities from the API
                try {
                    const res = await fetch('/api/products/recent-activities', { credentials: 'same-origin' });
                    console.log('Activities API response status:', res.status); // Debug log
                    if(res.ok) {
                        const data = await res.json();
                        console.log('Activities API response data:', data); // Debug log
                        if(data.success && Array.isArray(data.activities)) {
                            activities = data.activities;
                            console.log('Activities loaded from API:', activities.length); // Debug log
                        } else {
                            console.error('API returned error or invalid data:', data);
                        }
                    } else {
                        console.error('API returned HTTP error:', res.status);
                    }
                } catch(e) {
                    console.error('Network error fetching activities from API:', e);
                }

                // If API didn't return activities, get them manually from products and notes
                if(activities.length === 0) {
                    console.log('Fetching activities manually...');
                    
                    // Fetch products to create activity entries
                    try {
                        const prodRes = await fetch('/api/products', { credentials: 'same-origin' });
                        if(prodRes.ok) {
                            const prodData = await prodRes.json();
                            if(prodData.success && Array.isArray(prodData.products)) {
                                // Add product activities (creation and updates)
                                prodData.products.forEach(product => {
                                    // Add creation/update activity
                                    activities.push({
                                        id: `prod-${product.id}`,
                                        type: 'product',
                                        title: `Menambahkan bahan: ${product.name}`,
                                        description: `Stok: ${product.stock_quantity} ${product.unit || ''}`,
                                        timestamp: product.created_at || product.updated_at || new Date().toISOString(),
                                        icon: 'fa-box-open',
                                        colorClass: 'act-add'
                                    });
                                    
                                    // Add low stock warning if applicable
                                    if(parseFloat(product.stock_quantity) <= parseFloat(product.min_stock_level || 0)) {
                                        activities.push({
                                            id: `low-stock-${product.id}`,
                                            type: 'system_warning',
                                            title: `Peringatan: Stok ${product.name} menipis`,
                                            description: `Stok: ${product.stock_quantity} ${product.unit || ''}. Segera isi ulang.`,
                                            timestamp: product.updated_at || product.created_at || new Date().toISOString(),
                                            icon: 'fa-exclamation-triangle',
                                            colorClass: 'act-warning'
                                        });
                                    }
                                    
                                    // Add expiry warning if applicable
                                    if(product.expiry_date) {
                                        const expiryDate = new Date(product.expiry_date);
                                        const today = new Date();
                                        const diffTime = expiryDate - today;
                                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                        
                                        if(diffDays <= 7 && diffDays >= 0) {
                                            activities.push({
                                                id: `expiring-${product.id}`,
                                                type: 'system_warning',
                                                title: `Peringatan: ${product.name} akan kadaluarsa`,
                                                description: `Kadaluarsa dalam ${diffDays} hari`,
                                                timestamp: product.updated_at || product.created_at || new Date().toISOString(),
                                                icon: 'fa-clock',
                                                colorClass: 'act-warning'
                                            });
                                        } else if(diffDays < 0) {
                                            activities.push({
                                                id: `expired-${product.id}`,
                                                type: 'system_warning',
                                                title: `Peringatan: ${product.name} telah kadaluarsa`,
                                                description: `Harus diganti segera`,
                                                timestamp: product.updated_at || product.created_at || new Date().toISOString(),
                                                icon: 'fa-skull-crossbones',
                                                colorClass: 'act-warning'
                                            });
                                        }
                                    }
                                });
                            }
                        }
                    } catch(e) {
                        console.error('Error fetching products for activities:', e);
                    }

                    // Fetch notes to create activity entries
                    try {
                        const notesRes = await fetch('/api/notes', { credentials: 'same-origin' });
                        if(notesRes.ok) {
                            const notesData = await notesRes.json();
                            if(notesData.success && Array.isArray(notesData.notes)) {
                                // Add note activities
                                notesData.notes.forEach(note => {
                                    activities.push({
                                        id: `note-${note.id}`,
                                        type: 'note',
                                        title: `Menambahkan catatan: ${note.title}`,
                                        description: note.content.substring(0, 50) + (note.content.length > 50 ? '...' : ''),
                                        timestamp: note.created_at || note.updated_at || new Date().toISOString(),
                                        icon: 'fa-sticky-note',
                                        colorClass: 'act-note'
                                    });
                                });
                            }
                        }
                    } catch(e) {
                        console.error('Error fetching notes for activities:', e);
                    }
                }

                // Sort activities by timestamp (newest first)
                activities.sort((a, b) => {
                    const dateA = new Date(a.timestamp);
                    const dateB = new Date(b.timestamp);
                    
                    // Handle invalid dates
                    if (isNaN(dateA.getTime())) return 1;
                    if (isNaN(dateB.getTime())) return -1;
                    
                    return dateB - dateA; // Descending order (newest first)
                });

                // Limit to 10 most recent activities
                activities = activities.slice(0, 10);

                // Render List
                list.innerHTML = '';
                if(activities.length === 0) {
                    list.innerHTML = '<li style="text-align:center; color:var(--text-muted); padding:20px;">Belum ada aktivitas.</li>';
                    return;
                }

                activities.forEach((act, index) => {
                    // Tentukan tipe icon jika belum diset logic sistem
                    let iconClass = act.icon || 'fa-info-circle';
                    let colorClass = act.colorClass || 'act-note'; // default

                    // Logika pewarnaan manual jika data dari API tidak lengkap
                    if(!act.colorClass) {
                        if(act.title.toLowerCase().includes('tambah') || act.type === 'product') {
                            iconClass = 'fa-plus-circle'; colorClass = 'act-add';
                        } else if(act.title.toLowerCase().includes('catatan') || act.type === 'note') {
                            iconClass = 'fa-sticky-note'; colorClass = 'act-note';
                        } else if(act.title.toLowerCase().includes('belanja')) {
                            iconClass = 'fa-shopping-cart'; colorClass = 'act-cart';
                        } else if(act.title.toLowerCase().includes('peringatan') || act.title.toLowerCase().includes('stok')) {
                            iconClass = 'fa-exclamation-triangle'; colorClass = 'act-warning';
                        } else if(act.title.toLowerCase().includes('kadaluarsa')) {
                            iconClass = 'fa-skull-crossbones'; colorClass = 'act-warning';
                        } else if(act.title.toLowerCase().includes('hapus')) {
                            iconClass = 'fa-trash'; colorClass = 'act-warning';
                        } else if(act.title.toLowerCase().includes('edit') || act.title.toLowerCase().includes('ubah')) {
                            iconClass = 'fa-edit'; colorClass = 'act-note';
                        } else if(act.title.toLowerCase().includes('akan')) {
                            iconClass = 'fa-clock'; colorClass = 'act-warning';
                        }
                    }

                    const item = `
                        <li class="activity-item animate-entry" style="animation-delay: ${index * 0.1}s">
                            <div class="activity-icon ${colorClass}">
                                <i class="fas ${iconClass}"></i>
                            </div>
                            <div class="activity-content">
                                <span class="activity-title">${act.title}</span>
                                <span class="activity-desc">${act.description || ''}</span>
                                <span class="activity-time"><i class="far fa-clock"></i> ${formatTimeAgo(act.timestamp)}</span>
                            </div>
                        </li>
                    `;
                    list.innerHTML += item;
                });

            } catch (e) {
                console.error('Error loading activities:', e);
                list.innerHTML = '<li style="text-align:center; color:var(--accent-red);">Gagal memuat aktivitas.</li>';
            }
        }

        // Function to record activities when user performs actions
        async function recordActivity(type, title, description = '', timestamp = new Date().toISOString()) {
            // This function would typically send data to the server to store the activity
            // For now, we'll just trigger a refresh of the activity feed
            console.log(`Activity recorded: ${type} - ${title}`);
            
            // Refresh the activity feed to show the new activity
            setTimeout(() => {
                loadActivities();
            }, 1000); // Delay to allow server to process the action
        }

        // Listen for custom events from other pages to update activities
        window.addEventListener('productAdded', (e) => {
            recordActivity('product', 'Menambahkan bahan baru', e.detail?.name || '');
        });

        window.addEventListener('productUpdated', (e) => {
            recordActivity('product', 'Memperbarui bahan', e.detail?.name || '');
        });

        window.addEventListener('productDeleted', (e) => {
            recordActivity('product', 'Menghapus bahan', e.detail?.name || '');
        });

        window.addEventListener('noteAdded', (e) => {
            recordActivity('note', 'Menambahkan catatan baru', e.detail?.title || '');
        });

        window.addEventListener('noteUpdated', (e) => {
            recordActivity('note', 'Memperbarui catatan', e.detail?.title || '');
        });

        window.addEventListener('noteDeleted', (e) => {
            recordActivity('note', 'Menghapus catatan', e.detail?.title || '');
        });

        // Also listen for page loads to ensure activities are updated
        window.addEventListener('load', () => {
            setTimeout(() => {
                loadActivities();
            }, 2000); // Delay to ensure everything is loaded
        });

        // Listen for storage events from other tabs/windows
        window.addEventListener('storage', (e) => {
            if (e.key === 'activityUpdate') {
                loadActivities();
            }
        });

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            updateGreeting();
            const isAuth = await checkAuthStatus();

            if(isAuth) {
                // Wait a bit to ensure DOM is fully loaded, then load data
                setTimeout(async () => {
                    await loadDashboardData();
                }, 500);
            } else {
                // Jika belum login, biarkan nilai tetap 0 seperti yang sudah ditentukan di HTML
            }

            // Refresh data tiap 30 detik
            setInterval(() => {
                if(isAuth) loadDashboardData();
            }, 30000);

            setInterval(updateGreeting, 60000);
        });

        // Event Listener untuk refresh saat user tambah bahan (simulasi komunikasi antar halaman jika SPA)
        window.addEventListener('productAdded', () => {
            setTimeout(loadDashboardData, 500);
        });
        
        window.addEventListener('productUpdated', () => {
            setTimeout(loadDashboardData, 500);
        });
        
        window.addEventListener('productDeleted', () => {
            setTimeout(loadDashboardData, 500);
        });
        
        window.addEventListener('noteAdded', () => {
            setTimeout(loadDashboardData, 500);
        });
        
        window.addEventListener('noteUpdated', () => {
            setTimeout(loadDashboardData, 500);
        });
        
        window.addEventListener('noteDeleted', () => {
            setTimeout(loadDashboardData, 500);
        });
    </script>
</body>
</html>