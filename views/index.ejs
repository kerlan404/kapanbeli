<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kapan Beli - Catatan Stok Bahan Masak</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ““</text></svg>" type="image/x-icon">

    <!-- Dashboard Stats Script -->
    <script src="/js/dashboard-stats.js" defer></script>

    <style>
        /* --- VARIABEL & TEMA --- */
        :root {
            /* Warna: Oranye Segar & Biru Profesional */
            --primary-orange: #FF9F43;
            --primary-blue: #2E86DE;
            --accent-green: #1DD1A1;
            --accent-red: #FF6B6B;
            
            /* Light Mode (Notebook Paper) */
            --bg-body: #F7F9FC;
            --bg-card: #FFFFFF;
            --text-main: #2C3E50;
            --text-muted: #8395A7;
            --nav-bg: rgba(255, 255, 255, 0.85);
            --shadow-card: 0 8px 24px rgba(149, 157, 165, 0.08);
            --shadow-hover: 0 12px 32px rgba(149, 157, 165, 0.15);
            --shadow-search: 0 15px 35px rgba(0,0,0,0.1);
            --border-radius: 24px;
            
            /* Pattern Dot Grid */
            --dot-color: #E1E8ED;
        }

        /* Dark Mode */
        body.dark-mode-active {
            --bg-body: #1E272E;
            --bg-card: #2C3E50;
            --text-main: #DFE6E9;
            --text-muted: #808E9B;
            --nav-bg: rgba(30, 39, 46, 0.9);
            --shadow-card: 0 8px 24px rgba(0, 0, 0, 0.2);
            --shadow-hover: 0 12px 32px rgba(0, 0, 0, 0.4);
            --shadow-search: 0 15px 35px rgba(0,0,0,0.5);
            --dot-color: #34495E;
        }

        /* --- RESET & GLOBAL --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease, transform 0.3s ease;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-body);
            background-image: radial-gradient(var(--dot-color) 1.5px, transparent 1.5px);
            background-size: 24px 24px;
            color: var(--text-main);
            line-height: 1.7;
            overflow-x: hidden;
        }

        ::selection { background: var(--primary-orange); color: white; }
        a { text-decoration: none; color: inherit; cursor: pointer; }
        ul { list-style: none; }

        /* --- ANIMASI --- */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }

        .animate-entry {
            opacity: 0; /* Mulai tersembunyi */
            animation: fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        .delay-1 { animation-delay: 0.1s; }
        .delay-2 { animation-delay: 0.2s; }
        .delay-3 { animation-delay: 0.3s; }
        .delay-4 { animation-delay: 0.4s; }

        /* --- NAVBAR --- */
        .navbar {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: var(--nav-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.02);
            padding: 1rem 0;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 800;
            font-size: 1.4rem;
            letter-spacing: -0.5px;
            color: var(--text-main);
        }

        .nav-brand i { color: var(--primary-orange); font-size: 1.6rem; }

        .nav-menu {
            display: flex;
            gap: 2.5rem;
        }

        .nav-link {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-muted);
            position: relative;
            padding: 5px 0;
        }

        .nav-link:hover, .nav-link.active { color: var(--primary-blue); }

        .nav-link::after {
            content: ''; position: absolute; width: 0; height: 2px; bottom: 0; left: 0;
            background-color: var(--primary-orange); transition: width 0.3s ease; border-radius: 2px;
        }
        .nav-link:hover::after, .nav-link.active::after { width: 100%; }

        .nav-actions { display: flex; align-items: center; gap: 1.2rem; }

        .btn-text { font-weight: 600; color: var(--primary-blue); font-size: 0.9rem; }
        .btn-text:hover { color: var(--primary-orange); }

        .dark-mode-toggle {
            background: transparent; 
            border: none;
            color: var(--text-main); width: 38px; height: 38px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            font-size: 0.9rem; opacity: 0.8;
        }
        .dark-mode-toggle:hover {
            opacity: 1; background-color: rgba(255, 159, 67, 0.1); color: var(--primary-orange); transform: rotate(15deg);
        }

        /* --- HERO SECTION --- */
        .hero {
            max-width: 1200px;
            margin: 4rem auto;
            padding: 0 24px;
            display: flex;
            align-items: center;
            min-height: 75vh;
            position: relative;
            overflow: hidden;
            border-radius: var(--border-radius);
        }

        /* --- SEARCH BAR STYLE (REVAMPED) --- */
        .search-container {
            position: relative;
            max-width: 550px; /* Sedikit lebih lebar */
            margin-bottom: 2.5rem;
            width: 100%;
            z-index: 200; /* Di atas konten lain */
        }

        .search-container input {
            width: 100%;
            padding: 18px 25px 18px 55px;
            border: 2px solid transparent;
            border-radius: 50px;
            background: var(--bg-card);
            box-shadow: var(--shadow-card);
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
            color: var(--text-main);
            outline: none;
            transition: all 0.3s ease;
        }

        .search-container input:focus { 
            box-shadow: 0 0 0 4px rgba(255, 159, 67, 0.2), var(--shadow-card); 
            transform: translateY(-2px); 
            border-color: var(--primary-orange);
            background: var(--bg-card);
        }

        .search-container i { 
            position: absolute; 
            left: 22px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: var(--primary-orange); 
            font-size: 1.2rem; 
            pointer-events: none; /* Agar klik ikon fokus ke input */
        }

        /* Search Results Dropdown */
        .search-results {
            position: absolute;
            top: calc(100% + 12px); /* Jarak 12px dari input */
            left: 0;
            width: 100%;
            background: var(--bg-card);
            border-radius: 20px;
            box-shadow: var(--shadow-search);
            z-index: 1000;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .search-results.active {
            max-height: 450px; /* Tinggi maksimal saat terbuka */
            opacity: 1;
            overflow-y: auto; /* Scroll jika panjang */
            transform: translateY(0);
        }

        .search-result-item {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(0,0,0,0.03);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.2s ease;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background-color: rgba(255, 159, 67, 0.05);
            padding-left: 25px; /* Efek geser sedikit */
        }

        /* Search Item Content */
        .search-result-icon {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            background: rgba(46, 134, 222, 0.1);
            color: var(--primary-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
            transition: background 0.2s, color 0.2s;
        }

        .search-result-item:hover .search-result-icon {
            background: var(--primary-orange);
            color: white;
        }

        .search-result-content {
            flex: 1;
            min-width: 0; /* Mencegah teks overflow */
        }

        .search-result-title {
            font-weight: 600;
            color: var(--text-main);
            font-size: 1rem;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-result-type {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        /* Empty State for Search */
        .search-no-results {
            padding: 30px 20px;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .hero-bg-image {
            position: absolute; top: 0; right: 0; width: 65%; height: 100%;
            background-image: url('https://z-cdn-media.chatglm.cn/files/3aaa6c94-c363-47e0-886e-817084f4b407.jpeg?auth_key=1870694353-37fd08f5dca94279b617d21318047ad0-0-84c2bb20f2aedb79ed770e63f95cd4fe');
            background-size: cover; background-position: center; z-index: 0;
            -webkit-mask-image: linear-gradient(to left, rgba(0,0,0,1) 50%, rgba(0,0,0,0) 100%);
            mask-image: linear-gradient(to left, rgba(0,0,0,1) 50%, rgba(0,0,0,0) 100%);
            transform: rotate(-1deg); border-radius: 30px 0 0 30px;
        }

        .hero-text { flex: 1; z-index: 2; position: relative; max-width: 550px; }

        .greeting-badge {
            display: inline-flex; align-items: center; gap: 8px;
            background: rgba(46, 134, 222, 0.1); color: var(--primary-blue);
            padding: 8px 20px; border-radius: 100px; font-size: 0.9rem; font-weight: 600;
            margin-bottom: 1.5rem; border: 1px solid rgba(46, 134, 222, 0.1);
            backdrop-filter: blur(4px); background-color: rgba(255, 255, 255, 0.85);
        }
        body.dark-mode-active .greeting-badge { background-color: rgba(30, 39, 46, 0.85); }

        .hero h1 {
            font-size: 3.8rem; line-height: 1.1; margin-bottom: 1.5rem;
            color: var(--text-main); letter-spacing: -1.5px; font-weight: 800;
        }

        .hero h1 span { color: var(--primary-orange); position: relative; display: inline-block; }
        
        .hero h1 span::after {
            content: ''; position: absolute; left: 0; bottom: 8px; width: 100%; height: 14px;
            background-color: rgba(255, 159, 67, 0.2); z-index: -1; border-radius: 4px;
        }

        .hero p { font-size: 1.15rem; color: var(--text-muted); margin-bottom: 2rem; max-width: 480px; line-height: 1.8; }

        .hero-buttons { display: flex; gap: 1rem; flex-wrap: wrap; }
        .cta-button {
            background-color: var(--primary-orange); color: white; padding: 16px 36px;
            border-radius: 100px; font-weight: 600; font-size: 1rem;
            box-shadow: 0 10px 25px rgba(255, 159, 67, 0.4); transition: all 0.3s;
            display: inline-flex; align-items: center; gap: 10px; border: none; cursor: pointer;
        }
        .cta-button:hover { transform: translateY(-4px); box-shadow: 0 15px 30px rgba(255, 159, 67, 0.5); background-color: #f08c38; }

        .secondary-button {
            background-color: var(--bg-card); border: 2px solid rgba(0,0,0,0.05);
            color: var(--text-main); padding: 14px 32px; border-radius: 100px; font-weight: 600;
            box-shadow: var(--shadow-card);
        }
        .secondary-button:hover { border-color: var(--primary-blue); color: var(--primary-blue); }

        /* --- SECTIONS UMUM --- */
        .section { padding: 5rem 24px; position: relative; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3rem; }
        
        .section-title {
            font-size: 2.2rem; color: var(--text-main); font-weight: 700;
            position: relative; display: inline-block;
        }
        .section-title::after { content: ''; display: block; width: 60px; height: 4px; background: var(--primary-orange); margin-top: 8px; border-radius: 2px; }

        .view-all-link { font-weight: 600; color: var(--primary-blue); display: flex; align-items: center; gap: 8px; transition: 0.3s; }
        .view-all-link:hover { color: var(--primary-orange); gap: 12px; }

        /* --- STATS SECTION (RINGKASAN DAPUR) --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; }
        
        .stat-card {
            background: var(--bg-card); padding: 2.5rem 2rem; border-radius: var(--border-radius);
            box-shadow: var(--shadow-card); text-align: center; border: 1px solid rgba(0,0,0,0.02);
            transition: all 0.4s ease; position: relative; overflow: hidden;
        }

        .stat-card:hover { transform: translateY(-10px); box-shadow: var(--shadow-hover); border-color: rgba(255, 159, 67, 0.3); }

        /* Hiasan background halus pada kartu stat */
        .stat-card::before {
            content: ''; position: absolute; top: -50px; right: -50px; width: 150px; height: 150px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            border-radius: 50%;
        }

        .stat-icon {
            font-size: 2.2rem; margin-bottom: 1.2rem; color: var(--primary-blue);
            background: rgba(46, 134, 222, 0.1); width: 75px; height: 75px; line-height: 75px;
            border-radius: 50%; margin-left: auto; margin-right: auto; transition: 0.3s;
        }

        .stat-card:hover .stat-icon { transform: scale(1.1) rotate(5deg); background: var(--primary-blue); color: white; }

        /* Variasi Warna Stat */
        .stat-card.danger .stat-icon { color: var(--accent-red); background: rgba(255, 107, 107, 0.1); }
        .stat-card.danger:hover .stat-icon { background: var(--accent-red); }
        
        .stat-card.warning .stat-icon { color: var(--primary-orange); background: rgba(255, 159, 67, 0.1); }
        .stat-card.warning:hover .stat-icon { background: var(--primary-orange); }

        .stat-value { font-size: 3rem; font-weight: 800; color: var(--text-main); margin-bottom: 0.2rem; line-height: 1; }
        .stat-label { color: var(--text-muted); font-weight: 600; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }

        /* --- PRODUCTS GRID (BAHAN SAYA) - UPDATED FOR LARGER IMAGES --- */
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 30px; }

        .product-card {
            background: var(--bg-card); border-radius: var(--border-radius); overflow: hidden;
            box-shadow: var(--shadow-card); display: flex; flex-direction: column;
            border: 1px solid rgba(0,0,0,0.03); transition: all 0.3s ease; position: relative;
        }

        .product-card:hover { transform: translateY(-8px); box-shadow: var(--shadow-hover); }

        .card-top {
            height: 200px; background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%);
            display: flex; align-items: center; justify-content: center; position: relative;
            overflow: hidden;
        }

        body.dark-mode-active .card-top { background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%); }

        .card-top img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            transition: transform 0.3s;
        }

        .product-card:hover .card-top img { transform: scale(1.05); }

        .card-icon { font-size: 5rem; color: var(--primary-orange); z-index: 2; transition: 0.3s; }
        .product-card:hover .card-icon { transform: scale(1.1) rotate(-5deg); }

        .category-tag {
            position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.95);
            padding: 6px 14px; border-radius: 20px; font-size: 0.75rem; font-weight: 700;
            color: var(--primary-blue); box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 3; backdrop-filter: blur(4px);
        }

        .card-body { padding: 24px; flex: 1; display: flex; flex-direction: column; gap: 14px; }

        .prod-name { font-size: 1.25rem; font-weight: 700; margin: 0; cursor: pointer; transition: color 0.2s; }
        .prod-name:hover { color: var(--primary-orange); }

        .info-row {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.9rem; padding-bottom: 10px; border-bottom: 1px dashed rgba(0,0,0,0.08);
        }
        .info-row:last-child { border-bottom: none; padding-bottom: 0; }

        .label { color: var(--text-muted); display: flex; align-items: center; gap: 8px; font-weight: 500; }
        .value { font-weight: 700; color: var(--text-main); font-size: 1rem; }

        /* --- NOTES GRID (CATATAN SAYA) - NEW --- */
        .notes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .note-card {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow-card);
            border-left: 4px solid var(--primary-blue);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .note-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-blue), var(--primary-orange));
        }

        .note-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .note-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            gap: 10px;
        }

        .note-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-main);
            margin: 0;
            cursor: pointer;
            transition: color 0.2s;
            flex: 1;
        }

        .note-title:hover {
            color: var(--primary-blue);
        }

        .note-date {
            font-size: 0.75rem;
            color: var(--text-muted);
            white-space: nowrap;
        }

        .note-content {
            color: var(--text-main);
            font-size: 0.95rem;
            line-height: 1.6;
            max-height: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 5;
            -webkit-box-orient: vertical;
        }

        .note-footer {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed rgba(0,0,0,0.1);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .note-btn {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: transparent;
        }

        .note-btn-edit {
            color: var(--primary-blue);
            background: rgba(46, 134, 222, 0.1);
        }

        .note-btn-edit:hover {
            background: var(--primary-blue);
            color: white;
        }

        .note-btn-delete {
            color: var(--accent-red);
            background: rgba(255, 107, 107, 0.1);
        }

        .note-btn-delete:hover {
            background: var(--accent-red);
            color: white;
        }

        .empty-notes {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-notes i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* --- ACTIVITY LIST (AKTIVITAS TERKINI) --- */
        .activity-container {
            background: var(--bg-card); border-radius: var(--border-radius);
            padding: 2.5rem; box-shadow: var(--shadow-card);
        }

        .activity-item {
            display: flex; align-items: center; padding: 1.2rem 0;
            border-bottom: 1px solid rgba(0,0,0,0.05); transition: background 0.2s;
        }
        .activity-item:last-child { border-bottom: none; }
        .activity-item:hover { background-color: rgba(0,0,0,0.02); padding-left: 10px; padding-right: 10px; border-radius: 12px; }

        .activity-icon {
            width: 50px; height: 50px; border-radius: 14px; display: flex; align-items: center; justify-content: center;
            margin-right: 1.5rem; font-size: 1.3rem; flex-shrink: 0;
        }

        /* Warna icon berdasarkan tipe */
        .act-add { background: rgba(29, 209, 161, 0.15); color: var(--accent-green); }
        .act-warning { background: rgba(255, 107, 107, 0.15); color: var(--accent-red); }
        .act-note { background: rgba(253, 203, 110, 0.2); color: #f39c12; }
        .act-cart { background: rgba(46, 134, 222, 0.15); color: var(--primary-blue); }

        .activity-content { flex: 1; }
        .activity-title { font-weight: 600; font-size: 1rem; color: var(--text-main); display: block; margin-bottom: 4px; }
        .activity-desc { font-size: 0.85rem; color: var(--text-muted); display: block; }
        .activity-time { font-size: 0.75rem; color: var(--text-muted); margin-top: 6px; font-weight: 500; opacity: 0.8; text-transform: uppercase; letter-spacing: 0.5px;}

        /* --- FOOTER --- */
        .footer {
            text-align: center; padding: 4rem 0; margin-top: 4rem; color: var(--text-muted);
            border-top: 1px solid rgba(0,0,0,0.05); background-color: var(--bg-card);
        }

        /* --- RESPONSIVE --- */
        @media (max-width: 968px) {
            .hero { flex-direction: column; text-align: center; gap: 2rem; margin-top: 2rem; padding-bottom: 2rem; }
            .hero-bg-image {
                position: relative; width: 100%; height: 300px; top: 0; right: 0;
                border-radius: 0 0 30px 30px; mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 70%, rgba(0,0,0,0) 100%);
                -webkit-mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 70%, rgba(0,0,0,0) 100%);
                order: -1; margin-bottom: 2rem;
            }
            .nav-menu { display: none; }
            .section-title { font-size: 1.8rem; }
        }

        /* Mobile Extra Small */
        @media (max-width: 576px) {
            .hero h1 { font-size: 2.2rem; }
            .hero p { font-size: 1rem; }
            
            .section { padding: 3rem 16px; }
            
            .stats-grid { grid-template-columns: 1fr; }
            
            .products-grid { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        }

        /* Tablet */
        @media (min-width: 577px) and (max-width: 768px) {
            .products-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>

    <%- include('./partials/navbar') %>

    <!-- HERO SECTION -->
    <section class="hero">
        <div class="hero-bg-image"></div>
        <div class="hero-text animate-entry delay-1">
            <span class="greeting-badge" id="greetingBadge">
                <i class="fas fa-sun"></i> <span id="greetingText">Selamat Pagi</span>
            </span>
            <h1>Catat Stok, <br><span>Matang Tanpa Ribet.</span></h1>
            <p>
                Asisten cerdas untuk mengelola stok dapur Anda. 
                Dapatkan notifikasi bahan habis, rekap belanja otomatis, dan temukan resep dengan mudah.
            </p>
            
            <div class="search-container animate-entry delay-2">
                <i class="fas fa-search"></i>
                <input type="text" id="heroSearch" placeholder="Cari bahan, resep, atau catatan..." autocomplete="off">
                <div class="search-results" id="searchResults">
                    <!-- Results will be injected here -->
                </div>
            </div>

            <div class="hero-buttons animate-entry delay-3">
                <a href="/notes" class="cta-button" id="mainActionBtn">
                    Mulai Catat <i class="fas fa-arrow-right"></i>
                </a>
                <a href="#features" class="secondary-button">Pelajari</a>
            </div>
        </div>
    </section>

    <!-- STATS SECTION -->
    <section class="section" id="features">
        <div class="container">
            <h2 class="section-title animate-entry delay-1" style="display:block; text-align:center;">Ringkasan Dapur</h2>
            <div class="stats-grid" id="statsGrid">
                <!-- Statistik dari server (EJS) -->
                <div class="stat-card animate-entry delay-1">
                    <div class="stat-icon"><i class="fas fa-box-open"></i></div>
                    <div class="stat-value" id="totalBahan"><%= typeof stats !== 'undefined' ? stats.totalBahan : 0 %></div>
                    <div class="stat-label">Total Bahan</div>
                </div>
                <div class="stat-card danger animate-entry delay-2">
                    <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="stat-value" id="stokMenipis"><%= typeof stats !== 'undefined' ? stats.stokMenipis : 0 %></div>
                    <div class="stat-label">Stok Menipis</div>
                </div>
                <div class="stat-card warning animate-entry delay-3">
                    <div class="stat-icon"><i class="fas fa-shopping-cart"></i></div>
                    <div class="stat-value" id="daftarBelanja"><%= typeof stats !== 'undefined' ? stats.daftarBelanja : 0 %></div>
                    <div class="stat-label">Daftar Belanja</div>
                </div>
                <div class="stat-card expired animate-entry delay-4">
                    <div class="stat-icon"><i class="fas fa-skull-crossbones"></i></div>
                    <div class="stat-value" id="kadaluarsa"><%= typeof stats !== 'undefined' ? stats.kadaluarsa : 0 %></div>
                    <div class="stat-label">Kadaluarsa</div>
                </div>
                <div class="stat-card expiring animate-entry delay-4">
                    <div class="stat-icon"><i class="fas fa-hourglass-half"></i></div>
                    <div class="stat-value" id="hampirKadaluarsa"><%= typeof stats !== 'undefined' ? stats.hampirKadaluarsa : 0 %></div>
                    <div class="stat-label">Hampir Kadaluarsa</div>
                </div>
                <div class="stat-card notes animate-entry delay-4">
                    <div class="stat-icon"><i class="fas fa-sticky-note"></i></div>
                    <div class="stat-value" id="totalCatatan"><%= typeof stats !== 'undefined' ? stats.totalCatatan : 0 %></div>
                    <div class="stat-label">Catatan</div>
                </div>
            </div>
        </div>
    </section>

    <!-- EMPTY STOCK WARNING SECTION (Conditional) -->
    <section class="section" id="emptyStockSection" style="display: none; background-color: rgba(255, 107, 107, 0.05);">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title" style="color: var(--accent-red);"><i class="fas fa-bell"></i> Segera Beli!</h2>
                <a href="/suggestions" class="view-all-link" style="color: var(--accent-red);">Lihat Daftar Belanja <i class="fas fa-arrow-right"></i></a>
            </div>
            <div class="products-grid" id="emptyStockGrid"></div>
        </div>
    </section>

    <!-- PRODUCTS SECTION - USER'S PRODUCTS -->
    <section class="section" id="productsSection">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title"><i class="fas fa-box-open" style="color: var(--primary-orange);"></i> Bahan Saya</h2>
                <a href="/products" class="view-all-link">Lihat Semua <i class="fas fa-arrow-right"></i></a>
            </div>
            <div class="products-grid" id="recentProductsGrid">
                <!-- Products will be loaded dynamically -->
            </div>
        </div>
    </section>

    <!-- NOTES SECTION - USER'S NOTES -->
    <section class="section" id="notesSection" style="background-color: rgba(0,0,0,0.02);">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title"><i class="fas fa-sticky-note" style="color: var(--primary-blue);"></i> Catatan Saya</h2>
                <a href="/notes" class="view-all-link">Lihat Semua <i class="fas fa-arrow-right"></i></a>
            </div>
            <div class="notes-grid" id="notesGrid">
                <!-- Notes will be loaded dynamically -->
            </div>
        </div>
    </section>

    <!-- ACTIVITY LIST -->
    <section class="section" style="background-color: rgba(0,0,0,0.02);">
        <div class="container">
            <h2 class="section-title" style="display:block; text-align:center; margin-bottom: 3rem;">Aktivitas Terkini</h2>
            <div class="activity-container animate-entry delay-2" style="max-width: 900px; margin: 0 auto;">
                <ul class="activity-list" style="padding: 0;" id="activityList">
                    <!-- Activities will be loaded dynamically -->
                </ul>
            </div>
        </div>
    </section>

    <%- include('./partials/footer') %>

    <script>
        // --- LOGIC 1: WAKTU & SALAM ---
        function updateGreeting() {
            const hour = new Date().getHours();
            const greetingText = document.getElementById('greetingText');
            const greetingIcon = document.querySelector('.greeting-badge i');
            
            if (hour >= 5 && hour < 11) {
                greetingText.textContent = "Selamat Pagi";
                greetingIcon.className = "fas fa-sun"; 
            } else if (hour >= 11 && hour < 15) {
                greetingText.textContent = "Selamat Siang";
                greetingIcon.className = "fas fa-cloud-sun"; 
            } else if (hour >= 15 && hour < 18) {
                greetingText.textContent = "Selamat Sore";
                greetingIcon.className = "fas fa-cloud-sun-rain"; 
            } else {
                greetingText.textContent = "Selamat Malam";
                greetingIcon.className = "fas fa-moon"; 
            }
        }

        // --- LOGIC 2: DARK MODE ---
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            const toggleBtn = document.querySelector('.dark-mode-toggle');
            const body = document.body;

            // Helper to get/set theme icon
            function getThemeIcon() {
                return toggleBtn ? toggleBtn.querySelector('i') : null;
            }

            // Check localStorage and apply theme (only if toggle button exists)
            if (toggleBtn) {
                if (localStorage.getItem('theme') === 'dark') {
                    enableDarkMode();
                }

                toggleBtn.addEventListener('click', () => {
                    body.classList.contains('dark-mode-active') ? disableDarkMode() : enableDarkMode();
                });
            }

            function enableDarkMode() {
                body.classList.add('dark-mode-active');
                localStorage.setItem('theme', 'dark');
                const icon = getThemeIcon();
                if (icon) {
                    icon.className = "fas fa-sun";
                    icon.style.color = "#F1C40F";
                }
            }

            function disableDarkMode() {
                body.classList.remove('dark-mode-active');
                localStorage.setItem('theme', 'light');
                const icon = getThemeIcon();
                if (icon) {
                    icon.className = "fas fa-moon";
                    icon.style.color = "";
                }
            }
        });

        // --- LOGIC 3: SEARCH BAR (IMPROVED UI) ---
        const searchInput = document.getElementById('heroSearch');
        const searchResults = document.getElementById('searchResults');
        let searchTimeout = null; // Debounce timer

        searchInput.addEventListener('input', function (e) {
            const query = e.target.value.trim();
            
            // Clear previous timeout
            if (searchTimeout) clearTimeout(searchTimeout);

            if (query === '') {
                searchResults.classList.remove('active');
                return;
            }

            // Debounce request (tunggu 300ms setelah user berhenti mengetik)
            searchTimeout = setTimeout(async () => {
                try {
                    // Show loading state (optional, bisa ditambahkan spinner)
                    searchResults.innerHTML = '<div class="search-no-results"><i class="fas fa-spinner fa-spin"></i> Mencari...</div>';
                    searchResults.classList.add('active');

                    // Search across products, notes
                    const [productsRes, notesRes] = await Promise.all([
                        fetch('/api/products', { credentials: 'same-origin' }),
                        fetch('/api/notes', { credentials: 'same-origin' })
                    ]);

                    const [productsData, notesData] = await Promise.all([
                        productsRes.json(),
                        notesRes.json()
                    ]);

                    const allResults = [];

                    // Search in products
                    if (productsData.success && productsData.products) {
                        productsData.products.forEach(product => {
                            if (product.name.toLowerCase().includes(query.toLowerCase())) {
                                allResults.push({
                                    type: 'product',
                                    title: product.name,
                                    description: 'Bahan Dapur',
                                    id: product.id,
                                    link: `/products/detail/${product.id}`,
                                    icon: 'fa-box-open'
                                });
                            }
                        });
                    }

                    // Search in notes
                    if (notesData.success && notesData.notes) {
                        notesData.notes.forEach(note => {
                            if (note.title.toLowerCase().includes(query.toLowerCase())) {
                                allResults.push({
                                    type: 'note',
                                    title: note.title,
                                    description: 'Catatan Pribadi',
                                    id: note.id,
                                    link: `/notes`,
                                    icon: 'fa-sticky-note'
                                });
                            }
                        });
                    }

                    // Display results
                    if (allResults.length > 0) {
                        searchResults.innerHTML = allResults.slice(0, 5).map(result => `
                            <div class="search-result-item" onclick="window.location.href='${result.link}'">
                                <div class="search-result-icon">
                                    <i class="fas ${result.icon}"></i>
                                </div>
                                <div class="search-result-content">
                                    <div class="search-result-title">${result.title}</div>
                                    <div class="search-result-type">${result.description}</div>
                                </div>
                                <i class="fas fa-chevron-right" style="color: var(--text-muted); font-size: 0.8rem;"></i>
                            </div>
                        `).join('');
                    } else {
                        searchResults.innerHTML = `
                            <div class="search-no-results">
                                <i class="fas fa-search" style="font-size: 1.5rem; margin-bottom: 10px; opacity: 0.5;"></i>
                                <div>Tidak ada hasil untuk "${query}"</div>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    searchResults.innerHTML = `
                        <div class="search-no-results" style="color: var(--accent-red);">
                            Terjadi kesalahan saat mencari
                        </div>
                    `;
                }
            }, 300); // 300ms debounce
        });

        // Handle Enter key (optional: go to full search page or trigger first result)
        searchInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                const query = this.value;
                if(query.trim() !== "") {
                    // Simulasi navigasi ke halaman pencarian penuh
                    window.location.href = `/products?search=${encodeURIComponent(query)}`;
                }
            }
        });

        // Hide search results when clicking outside
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.classList.remove('active');
            }
        });

        // --- LOGIC 4: AUTH CHECK ---
        const authLink = document.getElementById('authLink');
        const logoutLink = document.getElementById('logoutLink');
        const welcomeText = document.getElementById('welcomeText');
        const mainActionBtn = document.getElementById('mainActionBtn');
        // Note: These elements may not exist in all pages, so we check for null

        async function checkAuthStatus() {
            try {
                const response = await fetch('/auth/status', { method: 'GET', credentials: 'same-origin' });
                if (response.ok) {
                    const data = await response.json();
                    if (data.authenticated) {
                        if(authLink) authLink.style.display = 'none';
                        if(logoutLink) logoutLink.style.display = 'inline-block';
                        if(welcomeText) {
                            welcomeText.style.display = 'inline-block';
                            welcomeText.textContent = `Halo, ${data.user.name}!`;
                        }
                        if(mainActionBtn) {
                            mainActionBtn.innerHTML = 'Buka Catatan <i class="fas fa-book"></i>';
                            mainActionBtn.href = '/products';
                        }
                        return true; // Authenticated
                    }
                }
                // Default logged out state
                if(authLink) authLink.style.display = 'inline-block';
                if(logoutLink) logoutLink.style.display = 'none';
                if(welcomeText) welcomeText.style.display = 'none';
                if(mainActionBtn) {
                    mainActionBtn.innerHTML = 'Mulai Catat <i class="fas fa-arrow-right"></i>';
                    mainActionBtn.href = '/auth';
                }
                return false;
            } catch (error) {
                console.error('Auth check failed', error);
                return false;
            }
        }

        logoutLink.addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                const response = await fetch('/auth/logout', { method: 'POST', credentials: 'same-origin' });
                // Redirect langsung ke home page setelah logout
                window.location.href = '/';
            } catch (error) { 
                console.error('Logout error', error);
                window.location.href = '/';
            }
        });

        // --- LOGIC 5: MAIN DASHBOARD DATA (UPDATED) ---

        // Helper: Format Tanggal Indonesia
        function formatDateID(dateString) {
            if(!dateString) return '-';
            const options = { day: 'numeric', month: 'short', year: 'numeric' };
            return new Date(dateString).toLocaleDateString('id-ID', options);
        }

        // Helper: Cek Status Kedaluwarsa
        function getExpiryStatus(dateString) {
            if(!dateString) return { text: '-', class: '' };
            const now = new Date();
            const exp = new Date(dateString);
            const diffTime = exp - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 0) return { text: 'Kadaluarsa', class: 'text-danger', color: 'var(--accent-red)' };
            if (diffDays <= 7) return { text: `${diffDays} Hari Lagi`, class: 'text-warning', color: '#f39c12' };
            return { text: formatDateID(dateString), class: 'text-success', color: 'var(--accent-green)' };
        }

        // Helper: Icon berdasarkan nama bahan
        function getIconForProduct(name) {
            const n = name.toLowerCase();
            if(n.includes('ayam')) return 'fa-drumstick-bite';
            if(n.includes('susu')) return 'fa-glass-whiskey';
            if(n.includes('telur')) return 'fa-egg';
            if(n.includes('bawang')) return 'fa-seedling';
            if(n.includes('beras') || n.includes('gandum')) return 'fa-wheat';
            if(n.includes('cabai')) return 'fa-pepper-hot';
            if(n.includes('minyak')) return 'fa-bottle-droplet';
            return 'fa-box-open';
        }

        // Helper: Format "Waktu Lalu"
        function formatTimeAgo(dateString) {
            if (!dateString) return 'Baru saja';
            const date = new Date(dateString);
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " tahun lalu";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " bulan lalu";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " hari lalu";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " jam lalu";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " menit lalu";
            return "Baru saja";
        }

        // RENDER: Bahan Saya - Display user's products (show latest 6)
        function renderProducts(products, isAuthenticated = false) {
            const container = document.getElementById('recentProductsGrid');
            const section = document.getElementById('productsSection');

            // Jika user belum login, sembunyikan section
            if (!isAuthenticated) {
                section.style.display = 'none';
                return;
            }

            // Jika user sudah login tapi tidak ada produk, tampilkan empty state
            if(!products || products.length === 0) {
                section.style.display = 'block';
                container.innerHTML = `
                    <div class="empty-notes">
                        <i class="fas fa-box-open"></i>
                        <p>Belum ada bahan. Yuk tambahkan bahan pertama kamu!</p>
                        <a href="/products" class="cta-button" style="margin-top: 15px; font-size: 0.9rem; padding: 12px 28px;">
                            <i class="fas fa-plus"></i> Tambah Bahan
                        </a>
                    </div>
                `;
                return;
            }

            section.style.display = 'block';
            container.innerHTML = '';

            // Get latest 6 products
            const recentProducts = products.slice(0, 6);

            recentProducts.forEach((prod, index) => {
                const expiryInfo = getExpiryStatus(prod.expiry_date);
                const isLow = parseFloat(prod.stock_quantity) <= parseFloat(prod.min_stock_level || 0);

                const delayClass = index < 4 ? `delay-${index+1}` : 'delay-4';

                // Format stock quantity - remove .0 if whole number
                const stockNum = parseFloat(prod.stock_quantity) || 0;
                const stockDisplay = Number.isInteger(stockNum) ? stockNum.toString() : stockNum.toFixed(1);
                const unit = prod.unit || '';

                const card = `
                    <div class="product-card animate-entry ${delayClass}">
                        <div class="card-top">
                            <span class="category-tag">${prod.category_name || 'Umum'}</span>
                            ${prod.image_url
                                ? `<img src="${prod.image_url}" alt="${prod.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">`
                                : ''
                            }
                            <i class="fas ${getIconForProduct(prod.name)} card-icon" style="${prod.image_url ? 'display:none;' : ''}"></i>
                        </div>
                        <div class="card-body">
                            <h3 class="prod-name" onclick="window.location='/products/detail/${prod.id}'">${prod.name}</h3>

                            <div class="info-row">
                                <span class="label"><i class="fas fa-boxes"></i> Stok</span>
                                <span class="value" style="color: ${isLow ? 'var(--accent-red)' : 'var(--text-main)'}">
                                    ${stockDisplay} ${unit}
                                    ${isLow ? '<i class="fas fa-exclamation-circle" style="margin-left:5px; font-size:0.8rem;"></i>' : ''}
                                </span>
                            </div>

                            <div class="info-row" style="border:none;">
                                <span class="label"><i class="fas fa-calendar-check"></i> Kedaluwarsa</span>
                                <span class="value" style="color: ${expiryInfo.color}">${expiryInfo.text}</span>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });
        }

        // RENDER: Catatan Saya - Display user's notes (show latest 6)
        function renderNotes(notes, isAuthenticated = false) {
            const container = document.getElementById('notesGrid');
            const section = document.getElementById('notesSection');

            // Jika user belum login, sembunyikan section
            if (!isAuthenticated) {
                section.style.display = 'none';
                return;
            }

            // Jika user sudah login tapi tidak ada catatan, tampilkan empty state
            if(!notes || notes.length === 0) {
                section.style.display = 'block';
                container.innerHTML = `
                    <div class="empty-notes">
                        <i class="fas fa-sticky-note"></i>
                        <p>Belum ada catatan. Yuk buat catatan pertama kamu!</p>
                        <a href="/notes" class="cta-button" style="margin-top: 15px; font-size: 0.9rem; padding: 12px 28px;">
                            <i class="fas fa-plus"></i> Tambah Catatan
                        </a>
                    </div>
                `;
                return;
            }

            section.style.display = 'block';
            container.innerHTML = '';

            // Get latest 6 notes
            const recentNotes = notes.slice(0, 6);

            recentNotes.forEach((note, index) => {
                const delayClass = index < 4 ? `delay-${index+1}` : 'delay-4';
                const date = new Date(note.created_at);
                const formattedDate = date.toLocaleDateString('id-ID', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric'
                });

                const card = `
                    <div class="note-card animate-entry ${delayClass}">
                        <div class="note-card-header">
                            <h3 class="note-title" onclick="window.location='/notes'">${note.title}</h3>
                            <span class="note-date">${formattedDate}</span>
                        </div>
                        <div class="note-content">${note.content || 'Tidak ada isi catatan...'}</div>
                        <div class="note-footer">
                            <button class="note-btn note-btn-edit" onclick="editNote(${note.id})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="note-btn note-btn-delete" onclick="deleteNote(${note.id}, '${note.title.replace(/'/g, "\\'")}')">
                                <i class="fas fa-trash"></i> Hapus
                            </button>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });
        }

        // Fungsi Utama Load Data - UPDATED TO USE SERVER-SIDE STATS
        async function loadDashboardData() {
            console.log('=== Loading dashboard data... ===');

            // Check if stats grid exists
            const statsGrid = document.getElementById('statsGrid');
            if (!statsGrid) {
                console.error('Stats grid not found in DOM!');
                return;
            }

            const statCards = statsGrid.querySelectorAll('.stat-card .stat-value');
            console.log('Found', statCards.length, 'stat cards in DOM');

            // Track authentication status
            let isAuthenticated = false;

            // Track all stats in one object
            let dashboardStats = {
                total: 0,
                lowStock: 0,
                shoppingList: 0,
                expired: 0,
                expiring: 0,
                notes: 0
            };

            // Helper function to fetch with timeout
            const fetchWithTimeout = async (url, options = {}, timeout = 5000) => {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);
                const response = await fetch(url, { ...options, signal: controller.signal });
                clearTimeout(id);
                return response;
            };

            // 1. Fetch Products (untuk render grid dan low stock section)
            try {
                const prodRes = await fetchWithTimeout('/api/products', { credentials: 'same-origin' }, 5000);
                console.log('Products API response status:', prodRes.status);
                if(prodRes.ok) {
                    isAuthenticated = true;
                    const data = await prodRes.json();
                    console.log('Products received:', data);
                    if(data.success && Array.isArray(data.products)) {
                        dashboardStats.total = data.products.length;

                        // Calculate stats from products
                        const lowStockProducts = data.products.filter(p => {
                            const stock = parseFloat(p.stock_quantity) || 0;
                            const minLevel = parseFloat(p.min_stock_level) || 5;
                            return stock > 0 && stock <= minLevel;
                        });

                        const outOfStockProducts = data.products.filter(p => {
                            const stock = parseFloat(p.stock_quantity) || 0;
                            return stock <= 0;
                        });

                        const expiredProducts = data.products.filter(p => {
                            if (!p.expiry_date) return false;
                            const expiryDate = new Date(p.expiry_date);
                            const today = new Date();
                            return expiryDate < today;
                        });

                        const expiringSoonProducts = data.products.filter(p => {
                            if (!p.expiry_date) return false;
                            const expiryDate = new Date(p.expiry_date);
                            const today = new Date();
                            const diffDays = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                            return diffDays > 0 && diffDays <= 7;
                        });

                        dashboardStats.lowStock = lowStockProducts.length;
                        dashboardStats.shoppingList = lowStockProducts.length + outOfStockProducts.length;
                        dashboardStats.expired = expiredProducts.length;
                        dashboardStats.expiring = expiringSoonProducts.length;

                        // Render products on home page (latest 6)
                        renderProducts(data.products, true);
                        renderLowStockProducts(data.products);
                        updateKitchenSummary(data.products, dashboardStats);
                    } else {
                        console.error('Products API returned invalid data:', data);
                    }
                } else if (prodRes.status === 401) {
                    console.log('User not authenticated for products API');
                    // Render empty state for unauthenticated user
                    renderProducts([], false);
                } else {
                    console.error('Products API returned error:', prodRes.status);
                }
            } catch (e) {
                console.error('Products API error', e);
            }

            // 2. Fetch Notes (untuk update notes count DAN render notes section)
            try {
                const notesRes = await fetchWithTimeout('/api/notes', { credentials: 'same-origin' }, 5000);
                console.log('Notes API response status:', notesRes.status);
                if(notesRes.ok) {
                    isAuthenticated = true;
                    const notesData = await notesRes.json();
                    console.log('Notes received:', notesData);
                    if(notesData.success && Array.isArray(notesData.notes)) {
                        dashboardStats.notes = notesData.notes.length;
                        console.log('âœ… Notes count set to:', dashboardStats.notes);

                        // Render notes on home page (latest 6)
                        renderNotes(notesData.notes, true);
                    } else {
                        console.error('Notes API returned invalid data:', notesData);
                    }
                } else if (notesRes.status === 401) {
                    console.log('User not authenticated for notes API');
                    // Render empty state for unauthenticated user
                    renderNotes([], false);
                }
            } catch (e) {
                console.error('Notes API error', e);
            }

            // 3. Update Notes display (stats card)
            updateNotesSummary([]);

            // 4. Fetch & Render Activities
            await loadActivities();

            // FINAL: Update all stats one more time to ensure consistency
            console.log('=== Final dashboard stats ===');
            console.log('Total:', dashboardStats.total);
            console.log('Low Stock:', dashboardStats.lowStock);
            console.log('Shopping List:', dashboardStats.shoppingList);
            console.log('Expired:', dashboardStats.expired);
            console.log('Expiring:', dashboardStats.expiring);
            console.log('Notes:', dashboardStats.notes);
            
            // Force update all stat cards
            updateAllStats(dashboardStats);
        }

        // Function to force refresh dashboard data
        function refreshDashboardData() {
            console.log('Refreshing dashboard data...');
            loadDashboardData();
        }

        // Listen for events from other pages to refresh data
        window.addEventListener('productAdded', () => {
            setTimeout(refreshDashboardData, 1000); // Delay to allow server to process
        });

        window.addEventListener('productUpdated', () => {
            setTimeout(refreshDashboardData, 1000);
        });

        window.addEventListener('productDeleted', () => {
            setTimeout(refreshDashboardData, 1000);
        });

        window.addEventListener('noteAdded', () => {
            setTimeout(refreshDashboardData, 1000);
        });

        window.addEventListener('noteUpdated', () => {
            setTimeout(refreshDashboardData, 1000);
        });

        window.addEventListener('noteDeleted', () => {
            setTimeout(refreshDashboardData, 1000);
        });

        // Force update all stat cards
        function updateAllStats(stats) {
            console.log('Force updating all stat cards...');
            
            const statCards = document.querySelectorAll('#statsGrid .stat-card .stat-value');
            console.log('Found', statCards.length, 'stat cards');
            
            if (statCards.length >= 6) {
                // Update dengan nilai dari stats object
                // Jika stats bernilai 0, pertahankan nilai dari server (EJS)
                if (stats.total > 0) statCards[0].textContent = stats.total;
                if (stats.lowStock > 0) statCards[1].textContent = stats.lowStock;
                if (stats.shoppingList > 0) statCards[2].textContent = stats.shoppingList;
                if (stats.expired > 0) statCards[3].textContent = stats.expired;
                if (stats.expiring > 0) statCards[4].textContent = stats.expiring;
                if (stats.notes > 0) statCards[5].textContent = stats.notes;
                
                console.log('All stats updated:');
                console.log('1. Total:', statCards[0].textContent);
                console.log('2. Low Stock:', statCards[1].textContent);
                console.log('3. Shopping List:', statCards[2].textContent);
                console.log('4. Expired:', statCards[3].textContent);
                console.log('5. Expiring:', statCards[4].textContent);
                console.log('6. Notes:', statCards[5].textContent);
            } else {
                console.error('Could not find all 6 stat cards!');
            }
        }

        // Update kitchen summary with additional data
        function updateKitchenSummary(products, dashboardStats = {}) {
            // Calculate additional stats for kitchen summary
            const expiredProducts = products.filter(p => {
                if (!p.expiry_date) return false;
                const expiryDate = new Date(p.expiry_date);
                const today = new Date();
                return expiryDate < today;
            });

            const expiringSoon = products.filter(p => {
                if (!p.expiry_date) return false;
                const expiryDate = new Date(p.expiry_date);
                const today = new Date();
                const diffTime = expiryDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays > 0 && diffDays <= 7;
            });

            const lowStockProducts = products.filter(p => {
                const stock = parseFloat(p.stock_quantity) || 0;
                const minLevel = parseFloat(p.min_stock_level) || 5;
                return stock <= minLevel && stock > 0;
            });

            const outOfStockProducts = products.filter(p => {
                const stock = parseFloat(p.stock_quantity) || 0;
                return stock <= 0;
            });

            // Update all stat cards with calculated or passed values
            const totalProducts = dashboardStats.total || products.length;
            const lowStockCount = dashboardStats.lowStock || lowStockProducts.length;
            const shoppingListCount = dashboardStats.shoppingList || (lowStockProducts.length + outOfStockProducts.length);
            const expiredCount = dashboardStats.expired || expiredProducts.length;
            const expiringCount = dashboardStats.expiring || expiringSoon.length;
            const notesCount = dashboardStats.notes || 0;

            // Update each stat card
            const statCards = document.querySelectorAll('#statsGrid .stat-card .stat-value');
            
            if (statCards.length >= 6) {
                // 1. Total Bahan
                statCards[0].textContent = totalProducts;
                // 2. Stok Menipis
                statCards[1].textContent = lowStockCount;
                // 3. Daftar Belanja
                statCards[2].textContent = shoppingListCount;
                // 4. Kadaluarsa (expired)
                statCards[3].textContent = expiredCount;
                // 5. Hampir Kadaluarsa (expiring soon)
                statCards[4].textContent = expiringCount;
                // 6. Catatan (notes) - will be updated by updateNotesSummary
                statCards[5].textContent = notesCount;
            }
        }

        // Update notes summary
        function updateNotesSummary(notes) {
            const notesCount = notes.length;
            console.log('Updating notes count to:', notesCount);

            // Update the 6th stat card (Notes) - use multiple selectors for reliability
            const statCards = document.querySelectorAll('#statsGrid .stat-card .stat-value');
            console.log('Found stat cards:', statCards.length);

            if (statCards.length >= 6) {
                statCards[5].textContent = notesCount;
                console.log('Notes card updated via index 5');
            }

            // Also try by class name as backup
            const notesCard = document.querySelector('#statsGrid .stat-card.notes .stat-value');
            if (notesCard) {
                notesCard.textContent = notesCount;
                console.log('Notes card updated via class selector');
            }

            console.log('Final notes count in DOM:', document.querySelector('#statsGrid .stat-card:nth-child(6) .stat-value')?.textContent);
        }

        // Edit note function
        function editNote(noteId) {
            window.location.href = `/notes?id=${noteId}`;
        }

        // Delete note function
        async function deleteNote(noteId, noteTitle) {
            const result = await Swal.fire({
                title: 'Hapus Catatan?',
                text: `Apakah Anda yakin ingin menghapus catatan "${noteTitle}"?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: 'var(--accent-red)',
                cancelButtonColor: 'var(--text-muted)',
                confirmButtonText: 'Ya, Hapus',
                cancelButtonText: 'Batal'
            });

            if (result.isConfirmed) {
                try {
                    const response = await fetch(`/api/notes/${noteId}`, {
                        method: 'DELETE',
                        credentials: 'same-origin'
                    });

                    const data = await response.json();

                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Catatan Berhasil Dihapus!',
                            timer: 2000,
                            showConfirmButton: false
                        });

                        // Dispatch event untuk refresh data
                        window.dispatchEvent(new CustomEvent('noteDeleted'));
                        
                        // Reload notes
                        loadNotes();
                    } else {
                        Swal.fire('Gagal', data.message, 'error');
                    }
                } catch (error) {
                    console.error('Delete note error:', error);
                    Swal.fire('Error', 'Terjadi kesalahan saat menghapus catatan.', 'error');
                }
            }
        }

        // LOAD: Catatan Saya
        async function loadNotes() {
            try {
                const notesRes = await fetch('/api/notes', { credentials: 'same-origin' });
                
                if(notesRes.ok) {
                    const notesData = await notesRes.json();
                    if(notesData.success && Array.isArray(notesData.notes)) {
                        renderNotes(notesData.notes);
                    }
                }
            } catch (e) {
                console.error('Load notes error:', e);
            }
        }

        // RENDER: Stok Menipis (Otomatis muncul jika ada)
        function renderLowStockProducts(products) {
            const container = document.getElementById('emptyStockGrid');
            const section = document.getElementById('emptyStockSection');

            // Filter stok <= 0 (habis) atau stok <= min_stock (menipis)
            const lowStock = products.filter(p => parseFloat(p.stock_quantity) <= parseFloat(p.min_stock_level || 0));

            if(lowStock.length > 0) {
                section.style.display = 'block';
                container.innerHTML = '';

                lowStock.forEach((prod, index) => {
                    const delayClass = index < 3 ? `delay-${index+1}` : 'delay-3';
                    
                    // Format stock quantity - remove .0 if whole number
                    const stockNum = parseFloat(prod.stock_quantity) || 0;
                    const stockDisplay = Number.isInteger(stockNum) ? stockNum.toString() : stockNum.toFixed(1);
                    const unit = prod.unit || '';
                    
                    const card = `
                        <div class="product-card animate-entry ${delayClass}" style="border: 1px solid rgba(255, 107, 107, 0.3);">
                            <div class="card-top" style="background: rgba(255, 107, 107, 0.1);">
                                <span class="category-tag" style="background:var(--accent-red); color:white;">Darurat</span>
                                <i class="fas ${getIconForProduct(prod.name)} card-icon" style="color: var(--accent-red);"></i>
                            </div>
                            <div class="card-body">
                                <h3 class="prod-name">${prod.name}</h3>
                                <div class="info-row">
                                    <span class="label">Sisa Stok</span>
                                    <span class="value" style="color: var(--accent-red); font-weight:800;">${stockDisplay} ${unit}</span>
                                </div>
                                <div class="info-row" style="border:none;">
                                    <a href="/suggestions" class="cta-button" style="width:100%; justify-content:center; padding:10px; font-size:0.9rem; margin-top:10px;">
                                        <i class="fas fa-cart-plus"></i> Beli Sekarang
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += card;
                });
            } else {
                section.style.display = 'none';
            }
        }

        // LOGIC BARU: Aktivitas Terkini Cerdas
        async function loadActivities() {
            const list = document.getElementById('activityList');
            
            list.innerHTML = '<div style="text-align:center; padding:20px;"><i class="fas fa-spinner fa-spin"></i> Memuat aktivitas...</div>';

            try {
                let activities = [];
                let isAuthenticated = false;

                console.log('Loading activities from products and notes...');

                // Fetch products to create activity entries
                try {
                    const prodRes = await fetch('/api/products', { credentials: 'same-origin' });
                    if(prodRes.ok) {
                        isAuthenticated = true;
                        const prodData = await prodRes.json();
                        if(prodData.success && Array.isArray(prodData.products)) {
                            prodData.products.forEach(product => {
                                const stockNum = parseFloat(product.stock_quantity) || 0;
                                const stockDisplay = Number.isInteger(stockNum) ? stockNum.toString() : stockNum.toFixed(1);
                                const unit = product.unit || '';

                                activities.push({
                                    id: `prod-${product.id}`,
                                    type: 'product',
                                    title: `Bahan ditambahkan: ${product.name}`,
                                    description: `Stok: ${stockDisplay} ${unit}`,
                                    timestamp: product.created_at,
                                    icon: 'fa-box-open',
                                    colorClass: 'act-add'
                                });
                            });
                        }
                    } else if (prodRes.status === 401) {
                        console.log('User not authenticated');
                        list.innerHTML = '<li style="text-align:center; color:var(--text-muted); padding:20px;">Silakan login untuk melihat aktivitas.</li>';
                        return;
                    }
                } catch(e) {
                    console.error('Error fetching products:', e);
                }

                // Fetch notes to create activity entries
                try {
                    const notesRes = await fetch('/api/notes', { credentials: 'same-origin' });
                    if(notesRes.ok) {
                        isAuthenticated = true;
                        const notesData = await notesRes.json();
                        if(notesData.success && Array.isArray(notesData.notes)) {
                            notesData.notes.forEach(note => {
                                activities.push({
                                    id: `note-${note.id}`,
                                    type: 'note',
                                    title: `Catatan: ${note.title}`,
                                    description: note.content.substring(0, 50) + (note.content.length > 50 ? '...' : ''),
                                    timestamp: note.created_at,
                                    icon: 'fa-sticky-note',
                                    colorClass: 'act-note'
                                });
                            });
                        }
                    }
                } catch(e) {
                    console.error('Error fetching notes:', e);
                }

                // Sort activities by timestamp (newest first)
                activities.sort((a, b) => {
                    const dateA = new Date(a.timestamp);
                    const dateB = new Date(b.timestamp);
                    if (isNaN(dateA.getTime())) return 1;
                    if (isNaN(dateB.getTime())) return -1;
                    return dateB - dateA;
                });

                // Limit to 10 most recent activities
                activities = activities.slice(0, 10);

                // Render List
                list.innerHTML = '';
                if(activities.length === 0) {
                    list.innerHTML = '<li style="text-align:center; color:var(--text-muted); padding:20px;">Belum ada aktivitas.</li>';
                    return;
                }

                activities.forEach((act, index) => {
                    // Tentukan tipe icon jika belum diset logic sistem
                    let iconClass = act.icon || 'fa-info-circle';
                    let colorClass = act.colorClass || 'act-note'; // default

                    // Logika pewarnaan manual jika data dari API tidak lengkap
                    if(!act.colorClass) {
                        if(act.title.toLowerCase().includes('tambah') || act.type === 'product') {
                            iconClass = 'fa-plus-circle'; colorClass = 'act-add';
                        } else if(act.title.toLowerCase().includes('catatan') || act.type === 'note') {
                            iconClass = 'fa-sticky-note'; colorClass = 'act-note';
                        } else if(act.title.toLowerCase().includes('belanja')) {
                            iconClass = 'fa-shopping-cart'; colorClass = 'act-cart';
                        } else if(act.title.toLowerCase().includes('peringatan') || act.title.toLowerCase().includes('stok')) {
                            iconClass = 'fa-exclamation-triangle'; colorClass = 'act-warning';
                        } else if(act.title.toLowerCase().includes('kadaluarsa')) {
                            iconClass = 'fa-skull-crossbones'; colorClass = 'act-warning';
                        } else if(act.title.toLowerCase().includes('hapus')) {
                            iconClass = 'fa-trash'; colorClass = 'act-warning';
                        } else if(act.title.toLowerCase().includes('edit') || act.title.toLowerCase().includes('ubah')) {
                            iconClass = 'fa-edit'; colorClass = 'act-note';
                        } else if(act.title.toLowerCase().includes('akan')) {
                            iconClass = 'fa-clock'; colorClass = 'act-warning';
                        }
                    }

                    const item = `
                        <li class="activity-item animate-entry" style="animation-delay: ${index * 0.1}s">
                            <div class="activity-icon ${colorClass}">
                                <i class="fas ${iconClass}"></i>
                            </div>
                            <div class="activity-content">
                                <span class="activity-title">${act.title}</span>
                                <span class="activity-desc">${act.description || ''}</span>
                                <span class="activity-time"><i class="far fa-clock"></i> ${formatTimeAgo(act.timestamp)}</span>
                            </div>
                        </li>
                    `;
                    list.innerHTML += item;
                });

            } catch (e) {
                console.error('Error loading activities:', e);
                list.innerHTML = '<li style="text-align:center; color:var(--accent-red);">Gagal memuat aktivitas.</li>';
            }
        }

        // Function to record activities when user performs actions
        async function recordActivity(type, title, description = '', timestamp = new Date().toISOString()) {
            // This function would typically send data to the server to store the activity
            // For now, we'll just trigger a refresh of the activity feed
            console.log(`Activity recorded: ${type} - ${title}`);
            
            // Refresh the activity feed to show the new activity
            setTimeout(() => {
                loadActivities();
            }, 1000); // Delay to allow server to process the action
        }

        // Listen for custom events from other pages to update activities
        window.addEventListener('productAdded', (e) => {
            recordActivity('product', 'Menambahkan bahan baru', e.detail?.name || '');
        });

        window.addEventListener('productUpdated', (e) => {
            recordActivity('product', 'Memperbarui bahan', e.detail?.name || '');
        });

        window.addEventListener('productDeleted', (e) => {
            recordActivity('product', 'Menghapus bahan', e.detail?.name || '');
        });

        window.addEventListener('noteAdded', (e) => {
            recordActivity('note', 'Menambahkan catatan baru', e.detail?.title || '');
        });

        window.addEventListener('noteUpdated', (e) => {
            recordActivity('note', 'Memperbarui catatan', e.detail?.title || '');
        });

        window.addEventListener('noteDeleted', (e) => {
            recordActivity('note', 'Menghapus catatan', e.detail?.title || '');
        });

        // Listen for storage events from other tabs/windows
        window.addEventListener('storage', (e) => {
            if (e.key === 'activityUpdate') {
                loadActivities();
            }
        });

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            updateGreeting();
            const isAuth = await checkAuthStatus();

            if(isAuth) {
                // Load data immediately without delay
                loadDashboardData();
                loadNotes();
                // Load activities with slight delay to ensure DOM is ready
                setTimeout(() => loadActivities(), 100);
            }

            // Refresh data tiap 30 detik
            setInterval(() => {
                if(isAuth) {
                    loadDashboardData();
                    loadNotes();
                }
            }, 30000);

            setInterval(updateGreeting, 60000);
        });

        // Event Listener untuk refresh saat user tambah bahan (simulasi komunikasi antar halaman jika SPA)
        window.addEventListener('productAdded', () => {
            setTimeout(loadDashboardData, 500);
        });
        
        window.addEventListener('productUpdated', () => {
            setTimeout(loadDashboardData, 500);
        });
        
        window.addEventListener('productDeleted', () => {
            setTimeout(loadDashboardData, 500);
        });
        
        window.addEventListener('noteAdded', () => {
            setTimeout(loadDashboardData, 500);
        });
        
        window.addEventListener('noteUpdated', () => {
            setTimeout(loadDashboardData, 500);
        });
        
        window.addEventListener('noteDeleted', () => {
            setTimeout(loadDashboardData, 500);
        });
    </script>
</body>
</html>