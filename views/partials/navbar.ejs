<!-- NAVBAR -->
<nav class="navbar">
    <div class="nav-container">
        <div class="nav-brand">
            <i class="fas fa-book-open"></i>
            <span>Kapan Beli</span>
        </div>

        <div class="nav-menu">
            <a href="/" class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'home' ? 'active' : '' %>">Beranda</a>
            <a href="/notes" class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'notes' ? 'active' : '' %>" onclick="checkAuth(event)">Catatan</a>
            <a href="/products" class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'products' ? 'active' : '' %>" onclick="checkAuth(event)">Bahan Saya</a>
            <a href="/suggestions" class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'suggestions' ? 'active' : '' %>" onclick="checkAuth(event)">Saran Belanja</a>
            <a href="/about" class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'about' ? 'active' : '' %>">Tentang Kami</a>
        </div>

        <div class="nav-actions">
            <div id="authContainer">
                <div id="unauthButtons" style="display: none;">
                    <a href="/auth" class="btn-text">Masuk</a>
                    <a href="/register" class="btn-primary">Daftar</a>
                </div>
                <a href="/user-profile" id="profilePhotoLink" style="display:none;">
                    <img id="navProfilePhoto" src="" alt="Profile" class="nav-profile-photo" />
                </a>
                <a href="/user-profile" id="profileLink" style="display:none;" class="profile-icon" title="Profil">
                    <i class="fas fa-user-circle"></i>
                </a>
                <a href="/auth/logout" id="logoutLink" style="display:none;" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Keluar</span>
                </a>
            </div>

            <button class="dark-mode-toggle" id="darkModeToggle" title="Ganti Mode">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </div>
</nav>

<script>
    async function checkAuthStatus() {
        try {
            const response = await fetch('/auth/status', {
                method: 'GET',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();

            const unauthButtons = document.getElementById('unauthButtons');
            const logoutLink = document.getElementById('logoutLink');
            const profileLink = document.getElementById('profileLink');
            const profilePhotoLink = document.getElementById('profilePhotoLink');
            const navProfilePhoto = document.getElementById('navProfilePhoto');

            if (data.authenticated) {
                // Hide login/register buttons
                unauthButtons.style.display = 'none';
                // Show logout and profile
                logoutLink.style.display = 'flex';

                if (data.user && data.user.profile_photo) {
                    navProfilePhoto.src = data.user.profile_photo;
                    navProfilePhoto.style.display = 'block';
                    profilePhotoLink.style.display = 'block';
                    profileLink.style.display = 'none';
                } else {
                    navProfilePhoto.style.display = 'none';
                    profilePhotoLink.style.display = 'block';
                    profileLink.style.display = 'flex';
                }
            } else {
                // Show login/register buttons
                unauthButtons.style.display = 'flex';
                // Hide logout and profile
                logoutLink.style.display = 'none';
                profileLink.style.display = 'none';
                profilePhotoLink.style.display = 'none';
                navProfilePhoto.style.display = 'none';
            }
        } catch (error) {
            console.error('Auth check error:', error);
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', checkAuthStatus);
    } else {
        checkAuthStatus();
    }

    function checkAuth(event) {
        event.preventDefault();
        const targetUrl = event.currentTarget.href;

        fetch('/auth/status', {
            method: 'GET',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' }
        })
            .then(res => res.json())
            .then(data => {
                if (data.authenticated) {
                    window.location.href = targetUrl;
                } else {
                    window.location.href = '/auth?returnUrl=' + encodeURIComponent(targetUrl);
                }
            })
            .catch(error => {
                console.error('Auth check error:', error);
                window.location.href = '/auth';
            });
    }
</script>

<style>
    .navbar {
        position: sticky;
        top: 0;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body.dark-mode-active .navbar {
        background: rgba(30, 39, 46, 0.9);
        border-bottom-color: rgba(255, 255, 255, 0.05);
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
    }

    .navbar.scrolled {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .nav-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 70px;
    }

    /* Brand */
    .nav-brand {
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 700;
        font-size: 1.4rem;
        color: var(--text-main);
        text-decoration: none;
        padding: 8px 12px;
        border-radius: 12px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .nav-brand:hover {
        background: rgba(255, 159, 67, 0.08);
        transform: translateX(-2px);
    }

    .nav-brand i {
        color: var(--primary-orange);
        font-size: 1.6rem;
        filter: drop-shadow(0 2px 4px rgba(255, 159, 67, 0.3));
    }

    /* Navigation Menu */
    .nav-menu {
        display: flex;
        gap: 4px;
        align-items: center;
        background: rgba(0, 0, 0, 0.02);
        padding: 6px;
        border-radius: 14px;
    }

    body.dark-mode-active .nav-menu {
        background: rgba(255, 255, 255, 0.03);
    }

    .nav-link {
        text-decoration: none;
        color: var(--text-muted);
        font-weight: 500;
        font-size: 0.92rem;
        padding: 10px 18px;
        border-radius: 10px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        white-space: nowrap;
    }

    .nav-link:hover {
        color: var(--text-main);
        background: rgba(46, 134, 222, 0.08);
    }

    .nav-link.active {
        color: white;
        background: linear-gradient(135deg, var(--primary-orange), var(--primary-blue));
        box-shadow: 0 4px 12px rgba(255, 159, 67, 0.3);
    }

    /* Actions */
    .nav-actions {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    #authContainer {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    #unauthButtons {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .btn-text {
        text-decoration: none;
        color: var(--text-main);
        font-weight: 600;
        font-size: 0.92rem;
        padding: 10px 18px;
        border-radius: 10px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .btn-text:hover {
        background: rgba(46, 134, 222, 0.08);
        color: var(--primary-blue);
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary-orange), var(--primary-blue));
        color: white !important;
        padding: 10px 22px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 0.92rem;
        text-decoration: none;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 12px rgba(255, 159, 67, 0.3);
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 159, 67, 0.4);
    }

    /* Profile */
    .nav-profile-photo {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--primary-orange);
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .nav-profile-photo:hover {
        transform: scale(1.08);
        border-color: var(--primary-blue);
        box-shadow: 0 4px 16px rgba(46, 134, 222, 0.3);
    }

    .profile-icon {
        color: var(--primary-orange);
        font-size: 1.5rem;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        text-decoration: none;
        padding: 8px;
        border-radius: 10px;
    }

    .profile-icon:hover {
        color: var(--primary-blue);
        transform: scale(1.08);
        background: rgba(255, 159, 67, 0.08);
    }

    /* Logout */
    .logout-btn {
        color: var(--accent-red);
        font-weight: 600;
        font-size: 0.92rem;
        padding: 10px 16px;
        border-radius: 10px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        background: rgba(255, 107, 107, 0.08);
    }

    .logout-btn:hover {
        background: rgba(255, 107, 107, 0.15);
        transform: translateX(-2px);
    }

    .logout-btn i {
        font-size: 1rem;
    }

    /* Dark Mode Toggle */
    .dark-mode-toggle {
        background: rgba(46, 134, 222, 0.1);
        border: none;
        color: var(--primary-blue);
        font-size: 1.1rem;
        cursor: pointer;
        width: 42px;
        height: 42px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        flex-shrink: 0;
    }

    .dark-mode-toggle:hover {
        background: rgba(46, 134, 222, 0.2);
        transform: rotate(20deg);
    }

    body.dark-mode-active .dark-mode-toggle {
        background: rgba(255, 159, 67, 0.15);
        color: var(--primary-orange);
    }

    body.dark-mode-active .dark-mode-toggle:hover {
        background: rgba(255, 159, 67, 0.25);
    }

    /* Mobile Responsive */
    @media (max-width: 992px) {
        .nav-menu {
            display: none;
        }

        .nav-container {
            padding: 0 16px;
        }

        .nav-brand span {
            display: none;
        }

        .nav-actions {
            gap: 8px;
        }

        .btn-text {
            padding: 8px 12px;
            font-size: 0.88rem;
        }

        .btn-primary {
            padding: 8px 16px;
            font-size: 0.88rem;
        }

        .logout-btn span {
            display: none;
        }
    }

    @media (max-width: 576px) {
        .nav-container {
            height: 60px;
        }

        .nav-brand {
            font-size: 1.2rem;
        }

        .nav-brand i {
            font-size: 1.4rem;
        }

        #unauthButtons .btn-text {
            display: none;
        }

        #unauthButtons .btn-primary {
            padding: 8px 14px;
        }
    }
</style>

<script>
    // Navbar scroll effect
    window.addEventListener('scroll', () => {
        const navbar = document.querySelector('.navbar');
        if (window.scrollY > 50) {
            navbar.classList.add('scrolled');
        } else {
            navbar.classList.remove('scrolled');
        }
    });
</script>
