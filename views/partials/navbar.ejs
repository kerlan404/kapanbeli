<!-- NAVBAR -->
<nav class="navbar">
    <div class="nav-container">
        <div class="nav-brand">
            <i class="fas fa-book-open"></i>
            <span>Kapan Beli</span>
        </div>

        <div class="nav-menu">
            <a href="/" class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'home' ? 'active' : '' %>">Beranda</a>
            <a href="/notes" class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'notes' ? 'active' : '' %>" onclick="checkAuth(event)">Catatan</a>
            <a href="/products" class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'products' ? 'active' : '' %>" onclick="checkAuth(event)">Bahan Saya</a>
            <a href="/suggestions" class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'suggestions' ? 'active' : '' %>" onclick="checkAuth(event)">Saran Belanja</a>
            <a href="/about" class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'about' ? 'active' : '' %>">Tentang Kami</a>
        </div>

        <div class="nav-actions">
            <div id="authContainer">
                <div id="unauthButtons" style="display: none;">
                    <a href="/auth" class="btn-text">Masuk</a>
                    <a href="/register" class="btn-primary">Daftar</a>
                </div>
                <a href="/user-profile" id="profilePhotoLink" style="display:none;">
                    <img id="navProfilePhoto" src="" alt="Profile" class="nav-profile-photo" />
                </a>
                <a href="/user-profile" id="profileLink" style="display:none;" class="profile-icon" title="Profil">
                    <i class="fas fa-user-circle"></i>
                </a>
                <a href="/auth/logout" id="logoutLink" style="display:none;" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Keluar</span>
                </a>
            </div>

            <button class="dark-mode-toggle" id="darkModeToggle" title="Ganti Mode">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </div>
</nav>

<script>
    async function checkAuthStatus() {
        try {
            const response = await fetch('/auth/status', {
                method: 'GET',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();

            const unauthButtons = document.getElementById('unauthButtons');
            const logoutLink = document.getElementById('logoutLink');
            const profileLink = document.getElementById('profileLink');
            const profilePhotoLink = document.getElementById('profilePhotoLink');
            const navProfilePhoto = document.getElementById('navProfilePhoto');

            if (data.authenticated) {
                // Hide login/register buttons
                unauthButtons.style.display = 'none';
                // Show logout and profile
                logoutLink.style.display = 'flex';

                if (data.user && data.user.profile_photo) {
                    navProfilePhoto.src = data.user.profile_photo;
                    navProfilePhoto.style.display = 'block';
                    profilePhotoLink.style.display = 'block';
                    profileLink.style.display = 'none';
                } else {
                    navProfilePhoto.style.display = 'none';
                    profilePhotoLink.style.display = 'block';
                    profileLink.style.display = 'flex';
                }
            } else {
                // Show login/register buttons
                unauthButtons.style.display = 'flex';
                // Hide logout and profile
                logoutLink.style.display = 'none';
                profileLink.style.display = 'none';
                profilePhotoLink.style.display = 'none';
                navProfilePhoto.style.display = 'none';
            }
        } catch (error) {
            console.error('Auth check error:', error);
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', checkAuthStatus);
    } else {
        checkAuthStatus();
    }

    function checkAuth(event) {
        event.preventDefault();
        const targetUrl = event.currentTarget.href;

        fetch('/auth/status', {
            method: 'GET',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' }
        })
            .then(res => res.json())
            .then(data => {
                if (data.authenticated) {
                    window.location.href = targetUrl;
                } else {
                    window.location.href = '/auth?returnUrl=' + encodeURIComponent(targetUrl);
                }
            })
            .catch(error => {
                console.error('Auth check error:', error);
                window.location.href = '/auth';
            });
    }
</script>

<style>
    .navbar {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px) saturate(180%);
        border-bottom: 1px solid rgba(46, 134, 222, 0.1);
        padding: 12px 5%;
        position: sticky;
        top: 0;
        z-index: 1000;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
    }

    body.dark-mode-active .navbar {
        background: rgba(30, 41, 51, 0.95);
        border-bottom-color: rgba(255, 255, 255, 0.1);
    }

    .nav-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1400px;
        margin: 0 auto;
    }

    .nav-brand {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 700;
        font-size: 1.4rem;
        color: var(--text-main, #2C3E50);
        text-decoration: none;
        padding: 8px 12px;
        border-radius: 10px;
        transition: all 0.3s;
    }

    body.dark-mode-active .nav-brand {
        color: var(--text-main-dark, #ECF0F1);
    }

    .nav-brand:hover {
        background: rgba(46, 134, 222, 0.1);
    }

    .nav-brand i {
        color: var(--primary-orange, #FF9F43);
        font-size: 1.5rem;
        filter: drop-shadow(0 2px 4px rgba(255, 159, 67, 0.3));
    }

    .nav-menu {
        display: flex;
        gap: 6px;
        align-items: center;
    }

    .nav-link {
        text-decoration: none;
        color: var(--text-muted, #636E72);
        font-weight: 500;
        font-size: 0.92rem;
        padding: 10px 16px;
        border-radius: 10px;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
    }

    body.dark-mode-active .nav-link {
        color: var(--text-muted-dark, #94A3B8);
    }

    .nav-link:hover {
        color: var(--text-main, #2C3E50);
        background: rgba(46, 134, 222, 0.08);
    }

    body.dark-mode-active .nav-link:hover {
        color: var(--text-main-dark, #ECF0F1);
    }

    .nav-link.active {
        color: var(--primary-blue, #2E86DE);
        background: rgba(46, 134, 222, 0.1);
    }

    .nav-link.active::after {
        content: '';
        position: absolute;
        bottom: 4px;
        left: 50%;
        transform: translateX(-50%);
        width: 60%;
        height: 3px;
        background: linear-gradient(90deg, var(--primary-blue, #2E86DE), var(--primary-orange, #FF9F43));
        border-radius: 2px;
    }

    .nav-actions {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    #authContainer {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    #unauthButtons {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .btn-text {
        text-decoration: none;
        color: var(--text-muted, #636E72);
        font-weight: 600;
        font-size: 0.92rem;
        padding: 8px 14px;
        border-radius: 8px;
        transition: all 0.3s;
        display: flex;
        align-items: center;
    }

    body.dark-mode-active .btn-text {
        color: var(--text-muted-dark, #94A3B8);
    }

    .btn-text:hover {
        color: var(--text-main, #2C3E50);
        background: rgba(46, 134, 222, 0.08);
    }

    body.dark-mode-active .btn-text:hover {
        color: var(--text-main-dark, #ECF0F1);
    }

    .btn-primary {
        background: var(--primary-orange, #FF9F43);
        color: white !important;
        padding: 8px 18px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.92rem;
        text-decoration: none;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        box-shadow: 0 2px 8px rgba(255, 159, 67, 0.3);
    }

    .btn-primary:hover {
        background: var(--primary-orange-dark, #E67E22);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255, 159, 67, 0.4);
    }

    .nav-profile-photo {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--primary-orange, #FF9F43);
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        display: block;
    }

    .nav-profile-photo:hover {
        transform: scale(1.1);
        border-color: var(--primary-blue, #2E86DE);
        box-shadow: 0 4px 12px rgba(46, 134, 222, 0.3);
    }

    .profile-icon {
        color: var(--primary-orange, #FF9F43);
        font-size: 1.4rem;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        text-decoration: none;
        padding: 6px;
        border-radius: 8px;
    }

    .profile-icon:hover {
        color: var(--primary-orange-dark, #FF8C00);
        transform: scale(1.1);
        background: rgba(255, 159, 67, 0.1);
    }

    .logout-btn {
        color: var(--accent-red, #FF6B6B);
        font-weight: 600;
        font-size: 0.92rem;
        padding: 8px 14px;
        border-radius: 8px;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 6px;
        text-decoration: none;
        white-space: nowrap;
    }

    .logout-btn i {
        font-size: 0.95rem;
        display: flex;
        align-items: center;
    }

    .logout-btn:hover {
        background: rgba(255, 107, 107, 0.1);
        color: var(--accent-red-dark, #EE5A5A);
    }

    .dark-mode-toggle {
        background: rgba(46, 134, 222, 0.1);
        border: none;
        color: var(--primary-blue, #2E86DE);
        font-size: 1rem;
        cursor: pointer;
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
        flex-shrink: 0;
    }

    .dark-mode-toggle:hover {
        background: rgba(46, 134, 222, 0.2);
        transform: rotate(15deg);
    }

    body.dark-mode-active .dark-mode-toggle {
        background: rgba(255, 159, 67, 0.15);
        color: var(--primary-orange, #FF9F43);
    }

    body.dark-mode-active .dark-mode-toggle:hover {
        background: rgba(255, 159, 67, 0.25);
    }

    @media (max-width: 768px) {
        .nav-menu {
            display: none;
        }

        .nav-actions {
            gap: 8px;
        }

        .btn-text,
        .btn-primary {
            padding: 6px 12px;
            font-size: 0.88rem;
        }

        .logout-btn span {
            display: none;
        }

        .nav-brand span {
            display: none;
        }
    }
</style>
