<!-- NAVBAR -->
<nav class="navbar">
    <div class="nav-container">
        <div class="nav-brand">
            <i class="fas fa-book-open"></i>
            <span>Kapan Beli</span>
        </div>

        <div class="nav-menu">
            <a href="/" class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'home' ? 'active' : '' %>">Beranda</a>
            <a href="/notes" class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'notes' ? 'active' : '' %>" onclick="checkAuth(event)">Catatan</a>
            <a href="/products" class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'products' ? 'active' : '' %>" onclick="checkAuth(event)">Bahan Saya</a>
            <a href="/suggestions" class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'suggestions' ? 'active' : '' %>" onclick="checkAuth(event)">Saran Belanja</a>
            <a href="/about" class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'about' ? 'active' : '' %>">Tentang Kami</a>
        </div>

        <div class="nav-actions">
            <div id="authContainer">
                <!-- Unauthenticated: Show Login & Register buttons -->
                <div id="unauthButtons" style="display: none;">
                    <a href="/auth" class="btn-text" style="margin-right: 15px;">Masuk</a>
                    <a href="/register" class="btn-primary" style="padding: 8px 20px; background: var(--primary-orange); color: white; border-radius: 8px; font-weight: 500;">Daftar</a>
                </div>
                <!-- Authenticated: Show Profile & Logout -->
                <a href="/user-profile" id="profilePhotoLink" style="display:none; text-decoration: none;">
                    <img id="navProfilePhoto" src="" alt="Profile" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-orange); margin-right: 10px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 0 10px rgba(255, 165, 0, 0.5)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'" />
                </a>
                <a href="/user-profile" class="btn-text" id="profileLink" style="display:none; margin-right: 15px; text-decoration: none;" title="Profil">
                    <i class="fas fa-user-circle" style="font-size: 28px; color: var(--primary-orange); cursor: pointer; transition: transform 0.2s, color 0.2s;" onmouseover="this.style.transform='scale(1.1)'; this.style.color='#FF8C00'" onmouseout="this.style.transform='scale(1)'; this.style.color='var(--primary-orange)'"></i>
                </a>
                <a href="/auth/logout" class="btn-text" id="logoutLink" style="display:none; color: var(--accent-red);">Keluar</a>
            </div>

            <button class="dark-mode-toggle" title="Ganti Mode">
                <i class="fas fa-moon" id="themeIcon"></i>
            </button>
        </div>
    </div>
</nav>

<script>
    // Check authentication status and update navbar
    async function checkAuthStatus() {
        try {
            const response = await fetch('/auth/status', {
                method: 'GET',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();

            const unauthButtons = document.getElementById('unauthButtons');
            const logoutLink = document.getElementById('logoutLink');
            const profileLink = document.getElementById('profileLink');
            const profilePhotoLink = document.getElementById('profilePhotoLink');
            const navProfilePhoto = document.getElementById('navProfilePhoto');

            if (data.authenticated) {
                // User is logged in
                unauthButtons.style.display = 'none';
                logoutLink.style.display = 'inline';
                
                // Show profile photo if exists
                if (data.user.profile_photo) {
                    navProfilePhoto.src = data.user.profile_photo;
                    navProfilePhoto.style.display = 'inline-block';
                    profilePhotoLink.style.display = 'inline-block';
                    profileLink.style.display = 'none';
                } else {
                    navProfilePhoto.style.display = 'none';
                    profilePhotoLink.style.display = 'inline-block';
                    profileLink.style.display = 'inline';
                }
            } else {
                // User is not logged in
                unauthButtons.style.display = 'inline-block';
                logoutLink.style.display = 'none';
                profileLink.style.display = 'none';
                profilePhotoLink.style.display = 'none';
                navProfilePhoto.style.display = 'none';
            }
        } catch (error) {
            console.error('Auth check error:', error);
        }
    }

    // Check auth when page loads
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', checkAuthStatus);
    } else {
        checkAuthStatus();
    }

    // Function to check auth before accessing protected pages
    function checkAuth(event) {
        event.preventDefault();
        const targetUrl = event.currentTarget.href;

        fetch('/auth/status', {
            method: 'GET',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(res => res.json())
            .then(data => {
                if (data.authenticated) {
                    window.location.href = targetUrl;
                } else {
                    // Redirect to login with return URL
                    window.location.href = '/auth?returnUrl=' + encodeURIComponent(targetUrl);
                }
            })
            .catch(error => {
                console.error('Auth check error:', error);
                window.location.href = '/auth';
            });
    }
</script>
