<!-- NAVBAR -->
<nav class="navbar">
    <div class="nav-container">
        <div class="nav-brand">
            <i class="fas fa-book-open"></i>
            <span>Kapan Beli</span>
        </div>

        <div class="nav-menu">
            <a href="/" class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'home' ? 'active' : '' %>">Beranda</a>
            <a href="/notes" class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'notes' ? 'active' : '' %>" onclick="checkAuth(event)">Catatan</a>
            <a href="/products" class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'products' ? 'active' : '' %>" onclick="checkAuth(event)">Bahan Saya</a>
            <a href="/suggestions" class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'suggestions' ? 'active' : '' %>" onclick="checkAuth(event)">Saran Belanja</a>
            <a href="/about" class="nav-link <%= typeof currentPage !== 'undefined' && currentPage === 'about' ? 'active' : '' %>">Tentang Kami</a>
        </div>

        <div class="nav-actions">
            <div id="authContainer">
                <!-- Unauthenticated: Show Login & Register buttons -->
                <div id="unauthButtons" style="display: none;">
                    <a href="/auth" class="btn-text" style="margin-right: 15px;">Masuk</a>
                    <a href="/register" class="btn-primary" style="padding: 8px 20px; background: var(--primary-orange); color: white; border-radius: 8px; font-weight: 500;">Daftar</a>
                </div>
                <!-- Authenticated: Show Profile & Logout -->
                <img id="navProfilePhoto" src="" alt="Profile" style="display:none; width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-orange); margin-right: 10px;" />
                <a href="/profile" class="btn-text" id="profileLink" style="display:none; margin-right: 15px;" title="Profil">
                    <i class="fas fa-user-circle"></i>
                </a>
                <a href="/auth/logout" class="btn-text" id="logoutLink" style="display:none; color: var(--accent-red);">Keluar</a>
            </div>

            <button class="dark-mode-toggle" title="Ganti Mode">
                <i class="fas fa-moon" id="themeIcon"></i>
            </button>
        </div>
    </div>
</nav>

<script>
    // Check authentication status and update navbar
    async function checkAuthStatus() {
        try {
            const response = await fetch('/auth/status');
            const data = await response.json();

            const unauthButtons = document.getElementById('unauthButtons');
            const logoutLink = document.getElementById('logoutLink');
            const profileLink = document.getElementById('profileLink');
            const navProfilePhoto = document.getElementById('navProfilePhoto');

            if (data.authenticated) {
                // User is logged in
                unauthButtons.style.display = 'none';
                logoutLink.style.display = 'inline';
                profileLink.style.display = 'inline';
                
                // Show profile photo if exists
                if (data.user.profile_photo) {
                    navProfilePhoto.src = data.user.profile_photo;
                    navProfilePhoto.style.display = 'inline-block';
                    profileLink.style.display = 'none'; // Hide icon when photo exists
                } else {
                    navProfilePhoto.style.display = 'none';
                    profileLink.style.display = 'inline';
                }
            } else {
                // User is not logged in
                unauthButtons.style.display = 'inline-block';
                logoutLink.style.display = 'none';
                profileLink.style.display = 'none';
                navProfilePhoto.style.display = 'none';
            }
        } catch (error) {
            console.error('Auth check error:', error);
        }
    }

    // Check auth when page loads
    document.addEventListener('DOMContentLoaded', checkAuthStatus);

    // Function to check auth before accessing protected pages
    function checkAuth(event) {
        event.preventDefault();
        const targetUrl = event.currentTarget.href;

        fetch('/auth/status')
            .then(res => res.json())
            .then(data => {
                if (data.authenticated) {
                    window.location.href = targetUrl;
                } else {
                    // Redirect to login with return URL
                    window.location.href = '/auth?returnUrl=' + encodeURIComponent(targetUrl);
                }
            })
            .catch(error => {
                console.error('Auth check error:', error);
                window.location.href = '/auth';
            });
    }
</script>
